---
title: "Project pike"
author: "TR"
date: '2022-09-02'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
library(tidyverse)
library(ggplot2)
library(lme4)
library(nlme)
library(lmerTest)
library(emmeans)
library(MuMIn)
library(visreg)
library(car)
library(sjPlot)
library(knitr)
library(car)
library(ggpubr)
library(mclust)
library(dtwclust)
library(vegan)
library(mvabund)
library(MASS)
library(flextable)
library(gridGraphics)
library(lubridate)
library(loo)
library(bayesplot)
library("rstan")
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

## preparation of Sr and d18O data
```{r marry d18O data to Sr, include=FALSE, eval=FALSE}
#Read in LA-ICPMS and SIMS data
rm(list = ls())

LA <- read.delim("Data/Pike/pike_data_LA-ICPMS_years_with_core.txt", 
                 header = T, stringsAsFactors = F, sep = "\t", dec = ".")

d18O <- read.delim("Data/Pike/pike_data_d18O_years.txt", header = T,
                stringsAsFactors = F, sep = "\t", dec = ".")

#Clean up data & assign capture locations to main areas
#Trace element data
LA <- LA%>%
  filter(LA_dist>=50)%>%
  transmute(ID = ID,
            age=age,
            capt = area,
            area = case_when(area %in% "Peene" ~ "Freshwater",
                             area %in% "Barthe" ~ "Freshwater",
                             area %in% "NHG" ~ "Freshwater",
                             area %in% "Sehrowbach" ~ "Freshwater",
                             area %in% "Bandycksgraben" ~ "Freshwater",
                             area %in% "Ziese" ~ "Freshwater",
                             area %in% "KB" ~ "WRB",
                             area %in% "SB" ~ "WRB",
                             area %in% "WB" ~ "NRB",
                             area %in% "BEG" ~ "NRB", 
                             area %in% "KJB" ~ "NRB",
                             area %in% "GJB" ~ "NRB",
                             area %in% "GB" ~ "GB",
                             area %in% "KD" ~ "control",
                             TRUE ~ "NA"),
            Sr = Sr,
            Na = Na,
            Mg = Mg,
            Ba = Ba,
            Mn = Mn,
            LA_dist = LA_dist,
            year=year)

#d18O data
d18O <- d18O%>%
  transmute(ID = ID,
            age=age,
            capt = area,
            area = case_when(area %in% "Peene" ~ "Freshwater",
                             area %in% "Barthe" ~ "Freshwater",
                             area %in% "NHG" ~ "Freshwater",
                             area %in% "Sehrowbach" ~ "Freshwater",
                             area %in% "Bandycksgraben" ~ "Freshwater",
                             area %in% "Ziese" ~ "Freshwater",
                             area %in% "KB" ~ "WRB",
                             area %in% "SB" ~ "WRB",
                             area %in% "WB" ~ "NRB",
                             area %in% "BEG" ~ "NRB", 
                             area %in% "KJB" ~ "NRB",
                             area %in% "GJB" ~ "NRB",
                             area %in% "GB" ~ "Marine",
                             area %in% "KD" ~ "Control",
                             TRUE ~ "NA"),
            d18O = d18O,
            sims_dist = sims_dist,
            year=year)

LA <- LA %>% drop_na()

#Smooth trace element data to get rid of extreme values
LA_smooth <- LA%>%group_by(ID)%>%
  transmute(ID=ID,
            age=age,
            capt=capt,
            area=area,
            Sr=as.numeric(zoo::rollmean(Sr, k=9, fill=NA, align = "left")),
            Na=as.numeric(zoo::rollmean(Na, k=9, fill=NA, align = "left")),
            Mg=as.numeric(zoo::rollmean(Mg, k=9, fill=NA, align = "left")),
            Ba=as.numeric(zoo::rollmean(Ba, k=9, fill=NA, align = "left")),
            Mn=as.numeric(zoo::rollmean(Mn, k=9, fill=NA, align = "left")),
            LA_dist=as.numeric(LA_dist),
            year=year)

#Order data for joining
d18O <- d18O[order(d18O$ID),]
LA <- LA[order(LA$ID),]
LA_smooth <- LA_smooth[order(LA_smooth$ID),]
LA_smooth <- data.frame(LA_smooth)

#reinterpolate Sr (higher spatial resolution) to d18O distances (lower spatial resolution) for joining
IDOto <- unique(d18O$ID)
dfE <- data.frame()
for (i in 1:length(IDOto)) {
  Sr <- data.frame(approx(LA_smooth[which(LA_smooth$ID==IDOto[i]),"LA_dist"],
              LA_smooth[which(LA_smooth$ID==IDOto[i]),"Sr"],
              n = length(d18O[which(d18O$ID==IDOto[i]),"sims_dist"]),
              rule = 1, method = "linear", ties = "ordered"))
  Na <- data.frame(approx(LA_smooth[which(LA_smooth$ID==IDOto[i]),"LA_dist"],
              LA_smooth[which(LA_smooth$ID==IDOto[i]),"Na"],
              n = length(d18O[which(d18O$ID==IDOto[i]),"sims_dist"]),
              rule = 1, method = "linear", ties = "ordered"))
  Mg <- data.frame(approx(LA_smooth[which(LA_smooth$ID==IDOto[i]),"LA_dist"],
              LA_smooth[which(LA_smooth$ID==IDOto[i]),"Mg"],
              n = length(d18O[which(d18O$ID==IDOto[i]),"sims_dist"]),
              rule = 1, method = "linear", ties = "ordered"))
  Ba <- data.frame(approx(LA_smooth[which(LA_smooth$ID==IDOto[i]),"LA_dist"],
              LA_smooth[which(LA_smooth$ID==IDOto[i]),"Ba"],
              n = length(d18O[which(d18O$ID==IDOto[i]),"sims_dist"]),
              rule = 1, method = "linear", ties = "ordered"))
  Mn <- data.frame(approx(LA_smooth[which(LA_smooth$ID==IDOto[i]),"LA_dist"],
              LA_smooth[which(LA_smooth$ID==IDOto[i]),"Mn"],
              n = length(d18O[which(d18O$ID==IDOto[i]),"sims_dist"]),
              rule = 1, method = "linear", ties = "ordered"))
  df <- cbind(Sr=Sr[,2], Na=Na[,2], Mg=Mg[,2], Ba=Ba[,2], Mn=Mn[,2])
  dfE <- rbind(dfE,df)
}

otoint_lowres <- cbind(d18O, dfE)
```

```{r covariance d18O and Sr, include=FALSE, eval=FALSE}
#read in data
otoint_lowres <- read.delim("Data/Pike/Oto_LA-to-d18O_interpolation.txt", 
                            header = T, stringsAsFactors = F, 
                            dec = ".", sep = "\t")

#clean up
Oto_lowres <- otoint_lowres%>%
  filter(ID!="BH-01908"&capt!="KD")%>%
  transmute(ID=ID,
            capt=capt,
            area=area,
            dist=sims_dist,
            Sr=Sr,
            d18O=d18O)%>%
  drop_na()

#plot high signal fish
Testfish1 <- Oto_lowres%>%filter(ID=="BH-90946")
Testfish2 <- Oto_lowres%>%filter(ID=="BH-91050")
Testfish3 <- Oto_lowres%>%filter(ID=="BH-90928")
Testfish4 <- Oto_lowres%>%filter(ID=="BH-01882")
Testfish5 <- Oto_lowres%>%filter(ID=="BH-01868")
Testfish6 <- Oto_lowres%>%filter(ID=="BH-01585")

P1 <- ggplot(Testfish1,aes(x=Sr, y=d18O))+
  geom_point()+
  labs(x="Sr/Ca (ppt)", y="d18O (permill)", 
       title="BH-90946, freshwater, likely anadromous")+
  ylim(-11,-3)+xlim(0,0.007)+
  theme_minimal()
P2 <- ggplot(Testfish2,aes(x=Sr, y=d18O))+
  geom_point()+
  labs(x="Sr/Ca (ppt)", y="d18O (permill)",
       title = "BH-91050, freshwater, likely anadromous")+
  ylim(-11,-3)+xlim(0,0.007)+
  theme_minimal()
P3 <- ggplot(Testfish3,aes(x=Sr, y=d18O))+
  geom_point()+
  labs(x="Sr/Ca (ppt)", y="d18O (permill)",
       title = "BH-90928, freshwater, likely anadromous")+
  ylim(-11,-3)+xlim(0,0.007)+
  theme_minimal()
P4 <- ggplot(Testfish4,aes(x=Sr, y=d18O))+
  geom_point()+
  labs(x="Sr/Ca (ppt)", y="d18O (permill)",
       title = "BH-01882, Bodden, likely resident")+
  ylim(-11,-3)+xlim(0,0.007)+
  theme_minimal()
P5 <- ggplot(Testfish5,aes(x=Sr, y=d18O))+
  geom_point()+
  labs(x="Sr/Ca (ppt)", y="d18O (permill)",
       title = "BH-01868, Bodden, likely resident")+
  ylim(-11,-3)+xlim(0,0.007)+
  theme_minimal()
P6 <- ggplot(Testfish6,aes(x=Sr, y=d18O))+
  geom_point()+
  labs(x="Sr/Ca (ppt)", y="d18O (permill)",
       title = "BH-01585, Bodden, likely resident")+
  ylim(-11,-3)+xlim(0,0.007)+
  theme_minimal()
ggarrange(P1,P2,P3,P4,P5,P6)



png(filename = "Figures/Correlation_d18O~Sr.png", 
    width = 3000, height = 1800, res = 600)
ggplot(Oto_lowres,aes(x=Sr*1000, y=d18O))+
  geom_point(size=.5)+
  scale_x_continuous(breaks = seq(0,8,1))+
  scale_y_continuous(breaks = seq(-15,0,1))+
  labs(x="Sr/Ca (mg/g)", 
       y=expression(bold(delta^18*"O"~("VPDB \u2030"))),
       title=expression(bold("Correlation of intraotolith Sr and"~delta^18*"O")))+
  stat_smooth(method = "lm", formula = y~exp(-x), fullrange = T, size = .8)+
  theme_classic()+
    theme(panel.grid.major = element_line(),
          axis.line = element_line(size = .5, colour = "black", linetype = 1),
          axis.ticks = element_line(size = .5, colour = "black"),
          axis.text = element_text(size = 10, colour = "black"),
          axis.title.x = element_text(size = 10, face = "bold"),
          axis.title.y = element_text(size = 10, face = "bold"),
          legend.text = element_text(size = 5),
          legend.title = element_text(size = 10, face = "bold"),
          plot.title = element_text(size = 15, face = "bold", hjust = .5))
dev.off()
```

```{r add corrected d18O to data, include=FALSE, eval=FALSE}
#read in data
otoint_lowres <- read.delim("Data/Pike/Oto_LA-to-d18O_interpolation.txt", 
                            header = T, stringsAsFactors = F, 
                            dec = ".", sep = "\t")

#Get residuals from d18O ~ Sr
subset_KD <- subset(otoint_lowres, capt=="KD")
subset_KD$res <- NA
otoint_lowres <- otoint_lowres%>%drop_na()%>%filter(capt!="KD")%>%filter(ID!="BH-01908")

#0-model
lm0 <- lm(d18O~1, data = otoint_lowres)
#normal model
lm1 <- lm(d18O~Sr, data = otoint_lowres)
#exponential decay
lm2 <- lm(d18O~exp(-Sr), data = otoint_lowres)

anova(lm0, lm1)
anova(lm0, lm2)
anova(lm1, lm2)
summary(lm1)


otoint_lowres$res <- lm1$residuals
otoint_lowres <- rbind(otoint_lowres, subset_KD)

#check for pattern retention
plot(otoint_lowres[otoint_lowres$ID=="BH-01889",]$sims_dist, otoint_lowres[otoint_lowres$ID=="BH-01889",]$res, type="l")
```

```{r average d18O residuals over years, include=FALSE, eval=FALSE}
#get d18O points per year to average over annual signal
otoint_lowres$year <- as.factor(otoint_lowres$year)

yearmean <- otoint_lowres%>%group_by(ID,year)%>%summarise(n=n())
mean(yearmean$n)
#mean of 7.6 so smooth with 7 or 8

otoint_lowres <- otoint_lowres%>%
  group_by(ID)%>%
  transmute(ID=ID,
            age=age,
            capt=capt,
            area=area,
            d18O=zoo::rollmean(d18O, k=7, fill = NA, align = "left"),
            res=zoo::rollmean(res, k=7, fill = NA, align = "left"),
            Sr=Sr,
            Na=Na,
            Mg=Mg,
            Ba=Ba,
            Mn=Mn,
            year=year,
            dist=sims_dist)

#check for pattern smoothness
plot(otoint_lowres[otoint_lowres$ID=="BH-01855",]$dist, otoint_lowres[otoint_lowres$ID=="BH-01855",]$d18O, type="l")

#Save data
write.table(otoint_lowres, "Data/Pike/Oto_LA-to-d18O_interpolation.txt", 
            row.names = F,dec = ".", sep = "\t")
```

## Lifelong niche on population level
```{r lifelong niche, include=FALSE, eval=FALSE}
#script to form annual means of elemental data for clustering and increment analysis
rm(list = ls())
#Read in data
otoint_lowres <- read.delim("Data/Pike/Oto_LA-to-d18O_interpolation.txt", header = T,
                            stringsAsFactors = F, dec = ".", sep = "\t")

otoint_lifehist <- otoint_lowres%>%
  transmute(ID=ID,
            age=as.factor(age),
            capt=capt,
            area=case_when(area=="WRB"~"Lagoon",
                           area=="NRB"~"Lagoon",
                           area=="Marine"~"Lagoon",
                           area=="Freshwater"~"Tributary"),
            d18O=d18O,
            d18O_res=res,
            Sr=Sr,
            year=as.factor(year),
            dist=dist)

# Plot lifelong increase in d18O --> colder the older
mypallette <- viridis::viridis(4, direction = 1)

d18O <- ggplot(otoint_lifehist, aes(year, d18O_res))+
  geom_boxplot(aes(color = area), width = 0.5, outlier.size = .5)+
  scale_x_discrete(limits = factor(1:10), breaks=c(1:10),
                   labels=c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10"))+
  labs(x="Age (years)",
       y=expression(bold("Sr-corrected"~delta^18*"O"~("VPDB \u2030"))),
       color="area of capture")+
  theme_classic()+
  scale_color_viridis_d(direction = 1, begin = 0, end = 0.7)+
  theme(panel.grid.major = element_line(),
        legend.position = "none",
        legend.background = element_blank(),
        legend.box.background = element_blank(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_text(size = 10, face = "bold",
                                    margin = margin(r=15)),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10, face = "bold"),
        legend.key.size = unit(.8,"line"))+
  coord_cartesian(clip = "off")+
  geom_segment(x=-0.56, y=0, xend=-0.56, yend=2.5, 
               lineend = "butt", linejoin = "mitre",
               size=3, arrow = arrow(length = unit(0.2, "inches")),
               color="#66CCCC")+
  annotation_custom(grob = text_grob(label = "lower temperature", 
                                     rot = 90, face = "bold", size = 7),
                                     ymin=0, ymax=2.5,
                                     xmin=-0.57, xmax=-0.57)+
  geom_segment(x=-0.56, y=0, xend=-0.56, yend=-2.5, 
               lineend = "butt", linejoin = "mitre",
               size=3, arrow = arrow(length = unit(0.2, "inches")),
               color="#FF6666")+
  annotation_custom(grob = text_grob(label = "higher temperature", 
                                     rot = -90, face = "bold", size = 7),
                                     ymin=0, ymax=-2.5,
                                     xmin=-0.54, xmax=-0.54)

#Lifelong increase in Sr/Ca --> saltier the older
SrCa <- ggplot(otoint_lifehist, aes(year, Sr*1000))+
  geom_boxplot(aes(color = area), width = 0.5, outlier.size = .5)+
  scale_x_discrete(limits = factor(1:10))+
  labs(x="Age (years)",
       y="Sr/Ca (mg/g)",
       color="area of capture")+
  theme_classic()+
  scale_color_viridis_d(direction = 1, begin = 0, end = 0.7)+
  theme(panel.grid.major = element_line(),
        legend.position = "none",
        legend.background = element_blank(),
        legend.box.background = element_blank(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 10, face = "bold"),
        legend.key.size = unit(.8,"line"))

png(filename = "Figures/Lifelong_niche_revised.png", 
    width = 4500, height = 1800, res = 600)
ggarrange(d18O, SrCa, ncol = 2, nrow = 1, labels = c("A", "B"), common.legend = TRUE,
                legend = "bottom")
dev.off()
```

## Model-based preclustering
```{r preclustering prep, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, eval=FALSE}
rm(list = ls())
#read in data
# oto_highres <- read.delim("Data/Otoliths/Oto_d18O-to-LA_interpolation.txt",
#                          header = T, dec = ".", sep = "\t",
#                          stringsAsFactors = F)
oto_lowres <- read.delim("Data/Pike/Oto_LA-to-d18O_interpolation.txt",
                         header = T, dec = ".", sep = "\t",
                         stringsAsFactors = F)

#Clustering step 1: model based clustering
#Form means
Elemeans <- oto_lowres%>%
  group_by(ID)%>%
  summarise(ID=ID,
            area=case_when(area=="WRB"~"Lagoon",
                           area=="NRB"~"Lagoon",
                           area=="Marine"~"Lagoon",
                           area=="Freshwater"~"Tributary",
                           area=="Control"~"Control lake"),
            Sr=mean(Sr),
            Na=mean(Na),
            Mg=mean(Mg),
            Ba=mean(Ba),
            Mn=mean(Mn),
            d18O=mean(d18O, na.rm=T))%>%
  na.omit()%>%
  distinct()

#Scale means
Elemeans[,3:8] <- scale(Elemeans[,3:8])
```

```{r preclustering, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, eval=FALSE}
#Visual examination of distinction potential
X <- data.matrix(Elemeans[,3:8])
class <- factor(Elemeans$area)
table(class)
col <- mclust.options("classPlotColors")[1:3]

clp <- clPairs(X, class, lower.panel=NULL, gap=0, symbols = c(16,15,17),
               colors = adjustcolor(col, alpha.f = 0.5))
clPairsLegend(x = 0.1, y = 0.3, class = clp$class, col = col, 
              pch = clp$pch, title = "Capture location")

#model-based clustering with the most promising predictors (Sr & d18O)
fit <- Mclust(Elemeans[,c(3,8)])

#Evaluation plots
par(mar=c(5,5,1,1))
plot(fit, what = "BIC", xlab="Number of clusters", 
     legendArgs=list(x="topright", ncol=2, cex=0.5, inset=0.01),
     cex.lab=3)

par(mar=c(5,6,1,1))
plot(fit, what = "classification", 
     ylab=expression(delta^18*"O (normalized)"),
     xlab="Sr/Ca (normalized)", cex.lab=2, cex.axis=2, cex=2)

plot(fit, what = "uncertainty")
plot(fit, what = "density")
summary(fit, parameters=T)

#Cluster again with best method
fit2 <- Mclust(Elemeans[,c(3,8)], G=3, modelNames = "VII")

#Assign cluster to data
Elemeans$clust <- as.factor(fit2$classification)

#Make list of cluster & ID
ClustID <- Elemeans[,c(1,9)]
```

```{r plot preclustering results, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, eval=FALSE}
#Plot cluster results
mypallette <- viridis::viridis(3, direction = 1)

png(filename = "Figures/Preclustering_results.png", 
    width = 3000, height = 1800, res = 600)
ggplot(Elemeans, aes(d18O, Sr, color=area, shape=clust))+
  labs(x=expression(bold(delta^18*"O (scaled)")), y="Sr/Ca (scaled)",
       shape="Cluster",
       title = "Preclustering results (VVI with 3 groups)")+
  geom_point(size=1)+
  theme_classic()+
  scale_color_manual(name="Capture location", 
                     breaks = c("Lagoon", "Tributary", "Control lake"),
                     values = mypallette)+
  theme(panel.grid.major = element_line(),
        axis.title = element_text(size = 10, face = "bold"), 
        axis.text = element_text(size = 10, colour = "black"),
        #legend.position = c(.85,.65),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = , face = "bold"),
        legend.key.size = unit(.5,"line"),
        legend.background = element_blank(),
        legend.box.background = element_rect(),
        plot.title = element_text(size = 15, face = "bold"))
dev.off()
```

```{r subset data according to preclustering results, include=FALSE, eval=FALSE}

#Join cluster grouping to data
oto_clusters <- oto_lowres%>%
  inner_join(ClustID, by = "ID")%>%
  group_by(ID)%>%
  na.omit()%>%
  transmute(ID=ID,
            age=age,
            capt=capt,
            area=area,
            d18O=d18O,
            d18O_res=res,
            Sr=Sr,
            Na=Na,
            Mg=Mg,
            Ba=Ba,
            Mn=Mn,
            year=year,
            clust=clust,
            dist=dist)

#subset according to cluster
Fgroup <- subset(oto_clusters, clust==1)
Bgroup <- subset(oto_clusters, clust==2)

#Test length, needs to equal N=86
length(unique(Bgroup$ID))+length(unique(Fgroup$ID))

#Function to reinterpolate an element to a specified length
interpol <- function(series, length, element){
  ids <- NULL
  values <- NULL
  
  IDOto <- unique(series$ID)
  
  for (i in 1:length(IDOto)) {
    id <- rep(IDOto[i], length.out=length)
    value <- approx(series[which(series$ID==IDOto[i]), element],
                      method = "linear", n=length, rule = 2)[2]
    ids <- c(ids, id)
    values <- unlist(c(values, value))
    }
  
  data.frame(ID=ids, value=values)
  
}

#Test function
Srall <- interpol(series = oto_clusters, length = 250, element = "Sr")
d18Oall <- interpol(series = oto_clusters, length = 250, element = "d18O")

Srd18O <- cbind(Srall, d18Oall[,2])
colnames(Srd18O) <- c("ID", "Sr", "d18O")


#compare pattern retention
par(mfrow=c(1,2))
plot(oto_clusters[oto_clusters$ID=="BH-91045",]$dist,
     oto_clusters[oto_clusters$ID=="BH-91045",]$Sr, type="l",
     xlab="Distance (um)", ylab="Sr/Ca")
plot(row_number(Srd18O[Srd18O$ID=="BH-91045",]$ID),
     Srd18O[Srd18O$ID=="BH-91045",]$Sr, type="l",
     xlab="transect cell", ylab="Sr/Ca")

#data package
save(Fgroup,Bgroup,interpol, file = "Data/Pike/Adults_element_transects.RData")
```

## DTW-clustering 3 year old pike
```{r get best clustering method?, include=FALSE, eval=FALSE}
rm(list = ls())
#read in data
Freshwater <- read.delim("Data/Otoliths/Freshwater-cluster.txt",
                         header = T, sep = "\t", dec = ".",
                         stringsAsFactors = F)

Bodden <- read.delim("Data/Otoliths/Bodden-cluster.txt",
                         header = T, sep = "\t", dec = ".",
                         stringsAsFactors = F)
Bodden <- Bodden%>%filter(ID!="BH-01908")

#make into list of matrices
IDOto <- unique(Bodden$ID)

series <- list()
for (i in 1:length(IDOto)) {
  m <- as.matrix(Bodden[which(Bodden$ID==IDOto[i]),c(5)])
  series[[length(series)+1]] <- m
}

names(series) <- c(IDOto)
labels <- NULL
Boddenlabels <- for (i in 1:length(IDOto)) {
  ind <- unique(Bodden[which(Bodden$ID==IDOto[i]), "area"])
  labels = c(labels, ind)
}

acf_fun <- function(series, ...) {
lapply(series, function(x) {
as.numeric(acf(x, lag.max = 50, plot = FALSE)$acf)
})
}


cfgs <- compare_clusterings_configs(
  types = c("h","t","f"),
  k = 2L,
  controls = list(hierarchical = hierarchical_control(method = "all"),
                tadpole = tadpole_control(dc = c(1.5,2), window.size = 5L),
                fuzzy = fuzzy_control(fuzziness = c(2,2.5),iter.max = 30L)
                ),
  preprocs = pdc_configs("preproc", none = list(),
                       zscore = list(center = c(FALSE)),
                       fuzzy = list(acf_fun=list()),
                       share.config = c("h", "t")
                       ),
  distances = pdc_configs("distance",
                        dtw=list(),fuzzy = list(L2 = list()),
                        share.config = c("h")
                        ),
  centroids = pdc_configs("centroid", hierarchical = list(default = list()),
                        fuzzy = list(fcmdd = list()),
                        tadpole = list(default = list(), 
                                       shape_extraction =list(znorm = TRUE)
                                       )
                        ),
  )

num_configs <- sapply(cfgs, attr, which = "num.configs")
cat("\nTotal number of configurations without considering optimizations:",
sum(num_configs),
"\n\n")


vi_evaluators <- cvi_evaluators("VI", ground.truth = labels)
score_fun <- vi_evaluators$score
pick_fun <- vi_evaluators$pick

comparison <- compare_clusterings(series, types = c("h", "t", "f"), configs = cfgs,
                                  trace = TRUE, seed = 293L, 
                                  score.clus = score_fun, pick.clus = pick_fun,
                                  return.objects = TRUE)
 #does not work yet... But unnecessary atm

```

```{r dtw data prep 3-year old, include=FALSE, eval=FALSE}
rm(list = ls())
#read in data
load("Data/Pike/Adults_element_transects.RData")

#Filter out vaterite fish, shorten to 3 year olds
Bgroup1 <- Bgroup%>%filter(ID!="BH-01908")%>%filter(age>=3, year<4)
Fgroup1 <- Fgroup%>%filter(age>=3, year<4)

#Look for sample size
length(unique(Bgroup1$ID))
length(unique(Fgroup1$ID))

#Mean transect length
summary(count(Bgroup1, "ID")) #Mean length 28 data points
summary(count(Fgroup1, "ID")) #Mean length 32 data points

#Make year a factor
Bgroup1$year <- as.factor(Bgroup1$year)
Fgroup1$year <- as.factor(Fgroup1$year)

#Calculate the number of transect cells needed to represent the "mean first"/"mean second"/
#"mean third" - year in standardized 30 cells interpolations
summary(Bgroup1$year)
year1 <- round((719/(719+446+243))*30,0)
year2 <- round((446/(719+446+243))*30,0)
year3 <- round((243/(719+446+243))*30,0)
year1+year2+year3 #needs to add up to 30

#reinterpolate to standard length
dataB1 <- interpol(series = Bgroup1, length = 30, element = "Sr")
dataB2 <- interpol(series = Bgroup1, length = 30, element = "d18O_res")

dataF1 <- interpol(series = Fgroup1, length = 30, element = "Sr")
dataF2 <- interpol(series = Fgroup1, length = 30, element = "d18O_res")

dataB <- cbind(dataB1, dataB2[,2])
dataF <- cbind(dataF1, dataF2[,2])

dataB[,2] <- scale(dataB[,2])
dataF[,2] <- scale(dataF[,2])

colnames(dataB) <- c("ID", "Sr", "d18O_res")
colnames(dataF) <- c("ID", "Sr", "d18O_res")

#make list of matrices for DTW
IDOto <- unique(dataB$ID)
Bseries <- list()

for (i in 1:length(IDOto)) {
  m <- as.matrix(dataB[which(dataB$ID==IDOto[i]),c(2,3)])
  Bseries[[length(Bseries)+1]] <- m
}

names(Bseries) <- c(IDOto)

IDOto <- unique(dataF$ID)
Fseries <- list()

for (i in 1:length(IDOto)) {
  m <- as.matrix(dataF[which(dataF$ID==IDOto[i]),c(2,3)])
  Fseries[[length(Fseries)+1]] <- m
}

names(Fseries) <- c(IDOto)

save(Fgroup,Bgroup,dataB, dataF, Bseries, Fseries, year1, year2, year3, interpol,
     file = "Data/Pike/Adults_element_transects_3-year.RData")
```

```{r DTW clustering 3 year olds, include=FALSE, eval=FALSE}
#cluster Bodden with cutoff test
clust_B <- tsclust(series = Bseries, type = "hierarchical",
                  k = 2L:6L,centroid = dba,
                  control = hierarchical_control(method = "ward.D"),
                  seed = 94L,args = tsclust_args(dist = list(window.size =5L)))

names(clust_B) <- paste0("k_",2L:6L)

sapply(clust_B, cvi, type = "internal")

#cluster FW with cutoff test
clust_F <- tsclust(series = Fseries, type = "hierarchical",
                  k = 2L:6L,centroid = dba,
                  control = hierarchical_control(method = "ward.D"),
                  seed = 96L,args = tsclust_args(dist = list(window.size =5L)))

names(clust_F) <- paste0("k_",2L:6L)

sapply(clust_F, cvi, type = "internal")

#Plot best solution lagoons
# png(filename = "C:/Users/timor/Nextcloud2/Timo/BODDENHECHT/Chapter 2/Stats/Niche analysis/Figures/Year_3_Sr_d18O_centroids.jpg", width = 2400, height = 800)
plot(clust_B$k_2, type="centroid", linetype="solid", 
     alpha=0.5, cex=1)+
  ylim(-2.5,3)+ggtitle(expression("Sr/"~delta^18~O~"cluster centroids"))+
  labs(x="transect cell", y="scaled value")+
  theme(axis.text = element_text(size = 25, color="black"),
        axis.title = element_text(size = 25),
        plot.title = element_text(size = 25, hjust = 0.5))
#dev.off()

#Plot best solution Freshwater
plot(clust_F$k_2, type="centroid", linetype="solid", cex=1)+
  ylim(-2.5,2)+xlim(0,60)+ggtitle(expression("Sr/"~delta^18~O~"cluster centroids"))+
  labs(x="transect cell", y="scaled value")+
  theme(axis.text = element_text(size = 25, color="black"),
        axis.title = element_text(size = 25),
        plot.title = element_text(size = 25, hjust = 0.5))
```

```{r cluster assignment 3 year olds, include=FALSE, eval=FALSE}
#assign clusters to fish
fishassign_B2 <- data.frame(ID=names(Bseries), 
                            clust2=factor(clust_B$k_2@cluster, 
                                           levels = c(1:2), 
                                           labels = c("High saline|warm",
                                                      "Low saline|cold")))

fishassign_F2 <- data.frame(ID=names(Fseries), 
                            clust2=factor(clust_F$k_2@cluster, 
                                           levels = c(1:2), 
                                           labels = c("FW low saline|cold",
                                                      "FW high saline|warm")))
#Join dtw clusters with pike data
Bgroup1$area <- ifelse(Bgroup1$area=="Marine", "GB", Bgroup1$area)

fishassign_B_3yr <- Bgroup1%>%
  group_by(ID)%>%
  transmute(ID=ID,
            capt=capt,
            area=as.factor(area),
            areaorder=case_when(area=="WRB"~1,
                                area=="NRB"~2,
                                area=="GB"~3,
                                area=="Freshwater"~4))%>%
  distinct()%>%
  inner_join(fishassign_B2, by="ID")%>%
  mutate(clust2=fct_relevel(clust2,
                             "Low saline|cold",
                             "High saline|warm"))

fishassign_F_3yr <- Fgroup1%>%
  group_by(ID)%>%
  transmute(ID=ID,
            capt=capt,
            area=area)%>%
  distinct()%>%
  inner_join(fishassign_F2, by="ID")%>%
  mutate(clust_O=fct_relevel(clust2,
                             "FW low saline|cold",
                             "FW high saline|warm"))

write.table(fishassign_B_3yr, file = "Data/Pike/Bodden_clusters_3-year.txt",
            row.names = F, sep = "\t", dec = ".")

write.table(fishassign_F_3yr, file = "Data/Pike/FW_clusters_3-year.txt",
            row.names = F, sep = "\t", dec = ".")
```

```{r plot Bodden proportions, eval=FALSE}
mypallette <- viridis::viridis(3, direction = -1)

#Plot Bodden proportions

#png(filename = "C:/Users/timor/Nextcloud2/Timo/BODDENHECHT/Chapter 2/Stats/Niche analysis/Figures/Clusterassign.jpg", width = 2400, height = 800)
ggplot(fishassign_B_3yr, aes(reorder(area.x, areaorder.x), fill=clust2))+
  geom_bar(position = "fill", width = .5)+theme_minimal()+
  labs(x="", y="proportion", fill="assigned cluster")+
  scale_fill_manual(breaks=c("Low saline|cold",
                             "High saline|warm"), 
                    values = mypallette)+
  theme(axis.text.y = element_text(size = 25, color = "black"),
        axis.text.x = element_text(size = 25, color = "black"),
        axis.title = element_text(size = 25),
        legend.text = element_text(size = 25),
        legend.title = element_text(size = 25),
        legend.position = "top")
#dev.off()

#Plot FW proportions
ggplot(fishassign_F_3yr, aes(capt, fill=clust2))+
  geom_bar(position = "fill", width = .5)+theme_minimal()+
  labs(x="", y="proportion", fill="assigned cluster")+
  scale_fill_manual(breaks=c("FW low saline|cold",
                             "FW high saline|warm"), 
                    values = mypallette)+
  theme(axis.text.y = element_text(size = 25, color = "black"),
        axis.text.x = element_text(size = 25, color = "black"),
        axis.title = element_text(size = 25),
        legend.text = element_text(size = 25),
        legend.title = element_text(size = 25),
        legend.position = "right")

write.table(fishassign_B, file = "Data/Pike/Year_3_Bclusters.txt", row.names = F,
            dec = ".", sep = "\t")
write.table(fishassign_F, file = "Data/Pike/Year_3_Fclusters.txt", row.names = F,
            dec = ".", sep = "\t")
```

```{r dissimilarity test, include=FALSE, eval=FALSE}
rm(list = ls())
#read in data
load("Data/Pike/Adults_element_transects.RData")

fishassign_B <- read.delim("Data/Pike/Bodden_clusters_3-year.txt", header = T,
                           stringsAsFactors = F, sep = "\t",dec=".")

fishassign_F <- read.delim("Data/Pike/FW_clusters_3-year.txt", header = T,
                           stringsAsFactors = F, sep = "\t",dec=".")

#transform data to all positive
dataB$d18O_res <- (dataB$d18O_res+sqrt((min(dataB$d18O_res))^2))
#So a value of d18O res is now to be interpreted as residual from predicted
#value + 2.518462

dataB$Sr <- (dataB$Sr+sqrt((min(dataB$Sr))^2))
#So a value of Sr is now to be interpreted as scaled value + 2.716513

#Same for reshwater group
dataF$d18O_res <- (dataF$d18O_res+sqrt((min(dataF$d18O_res))^2))
dataF$Sr <- (dataF$Sr+sqrt((min(dataF$Sr))^2))

#join
data <- rbind(dataB, dataF)

#make list of matrices Bodden
IDOto <- unique(data$ID)
series <- list()

for (i in 1:length(IDOto)) {
  m <- as.matrix(data[which(data$ID==IDOto[i]),c(2,3)])
  series[[length(series)+1]] <- m
}

names(series) <- c(IDOto)

#Revert from list to data frame, assign cell numbers
Series <- do.call(rbind.data.frame,series)
Series$ID <- substr(rownames(Series), 1,8)
rownames(Series) <- NULL
Series$cell <- rep(c(1:30), 62)

#Make cluster list
Bclust <- fishassign_B%>%
  transmute(ID=ID,
            clust=clust2)
Fclust <- fishassign_F%>%
  transmute(ID=ID,
            clust=clust2)

clust <- rbind(Bclust, Fclust)

#Assign years based on cell numbers, join with cluster ID
Series1 <- Series%>%
  mutate(year=case_when(cell<=year1~1,
                        cell<=year1+year2&cell>year1~2,
                        cell>year1+year2~3))%>%
  inner_join(clust, by="ID")%>%
  transmute(ID=ID,
            year=year,
            cell=cell,
            clust=clust,
            Sr=Sr,
            d18O_res=d18O_res)%>%
  group_by(ID, year)%>%
  summarize(ID=ID,
            year=year,
            clust=clust,
            Sr=mean(Sr),
            d18O_res=mean(d18O_res))%>%
  distinct()

#Make wide for testing
Series2 <- pivot_wider(Series1, names_from = year, values_from = c(Sr, d18O_res))
names(Series2) <- c("ID", "clust",
                    "Sr_orig", "Sr_juv", "Sr_adult", 
                    "O_orig", "O_juv", "O_adult")
#cluster needs to be a factor
Series2$clust <- as.factor(Series2$clust)

#make mvabund object of Sr and d18O data
elements <- mvabund(Series2[,3:8])

boxplot(elements)

Pikedist <- vegdist(elements, method = "euclidean")
Disp <- betadisper(Pikedist, Series2$clust)
anova(Disp)

plot(Disp)

adonis2(elements~Series2$clust, method = "euclidean", permutations = 9999)
```

```{r jackknife reclassification 3 year olds, eval=FALSE}
set.seed(123)
sample <- sample(c(TRUE, FALSE), nrow(Series2), 
                 replace = T, prob = c(0.6,0.4))
train <- Series2[sample,]
test <- Series2[!sample,]

lda.m1 <- lda(clust~Sr_orig+Sr_juv+Sr_adult+O_orig+O_juv+O_adult, 
              data = train)

#jackknife reclassification
lda.m2 <- lda(clust~Sr_orig+Sr_juv+Sr_adult+O_orig+O_juv+O_adult, 
              data = Series2, CV=TRUE)

Series2$jacknife <- lda.m2$class
summary <- Series2 %>% summarise(clust=clust,
                      jackknife=jacknife,
                      lda.error=mean(clust != jacknife))

success <- data.frame(HighSBodden=round(1-length(summary[summary$clust=="High saline|warm"&summary$lda.error==1,]$ID)/length(summary[summary$clust=="High saline|warm",]$ID),2), 
                      LowSBodden=round(1-length(summary[summary$clust=="Low saline|cold"&summary$lda.error==1,]$ID)/length(summary[summary$clust=="Low saline|cold",]$ID),2),
                      HighSFW=round(1-length(summary[summary$clust=="FW high saline|warm"&summary$lda.error==1,]$ID)/length(summary[summary$clust=="FW high saline|warm",]$ID),2),
                      LowSFW=round(1-length(summary[summary$clust=="FW low saline|cold"&summary$lda.error==1,]$ID)/length(summary[summary$clust=="FW low saline|cold",]$ID),2),
                      Overall=round(1-length(summary[summary$lda.error==1,]$ID)/length(summary$ID),4))
```

## DTW-clustering whole sample
```{r dtw data prep whole sample, include=FALSE, eval=FALSE}
rm(list = ls())
#read in data
load("Data/Pike/Adults_element_transects.RData")

#Filter out vaterite fish
Bgroup1 <- Bgroup%>%filter(ID!="BH-01908")
Fgroup1 <- Fgroup

#Look for sample size
length(unique(Bgroup1$ID))
length(unique(Fgroup1$ID))

#Mean transect length
summary(count(Bgroup1, "ID")) #Median length 39 data points
summary(count(Fgroup1, "ID")) #Median length 39 data points

#Make year a factor
Bgroup1$year <- as.factor(Bgroup1$year)
Fgroup1$year <- as.factor(Fgroup1$year)

#reinterpolate to standard length (40, based on both medians)
dataB1 <- interpol(series = Bgroup1, length = 35, element = "Sr")
dataB2 <- interpol(series = Bgroup1, length = 35, element = "d18O_res")

dataF1 <- interpol(series = Fgroup1, length = 40, element = "Sr")
dataF2 <- interpol(series = Fgroup1, length = 40, element = "d18O_res")

dataB <- cbind(dataB1, dataB2[,2])
dataF <- cbind(dataF1, dataF2[,2])

dataB[,2] <- scale(dataB[,2])
dataF[,2] <- scale(dataF[,2])

colnames(dataB) <- c("ID", "Sr", "d18O_res")
colnames(dataF) <- c("ID", "Sr", "d18O_res")

#make list of matrices for DTW
IDOto <- unique(dataB$ID)
Bseries <- list()

for (i in 1:length(IDOto)) {
  m <- as.matrix(dataB[which(dataB$ID==IDOto[i]),c(2,3)])
  Bseries[[length(Bseries)+1]] <- m
}

names(Bseries) <- c(IDOto)

IDOto <- unique(dataF$ID)
Fseries <- list()

for (i in 1:length(IDOto)) {
  m <- as.matrix(dataF[which(dataF$ID==IDOto[i]),c(2,3)])
  Fseries[[length(Fseries)+1]] <- m
}

names(Fseries) <- c(IDOto)

save(Fgroup,Bgroup,dataB, dataF, Bseries, Fseries, interpol,
     file = "Data/Pike/Adults_element_transects_prep.RData")
```

```{r DTW clustering all, include=FALSE, eval=FALSE}
load("Data/Pike/Adults_element_transects_prep.RData")

#cluster Bodden with cutoff test
clust_B <- tsclust(series = Bseries, type = "hierarchical",
                  k = 2L:6L,centroid = dba,
                  control = hierarchical_control(method = "ward.D"),
                  seed = 94L,args = tsclust_args(dist = list(window.size =5L)))

names(clust_B) <- paste0("k_",2L:6L)

sapply(clust_B, cvi, type = "internal")

#cluster FW with cutoff test
clust_F <- tsclust(series = Fseries, type = "hierarchical",
                  k = 2L:6L,centroid = dba,
                  control = hierarchical_control(method = "ward.D"),
                  seed = 96L,args = tsclust_args(dist = list(window.size =5L)))

names(clust_F) <- paste0("k_",2L:6L)

sapply(clust_F, cvi, type = "internal")

jpeg(filename = "Figures/Life-history-dendrograms_FW.jpg", 
    width = 6000, height = 3000, res = 600)
plot(clust_F$k_3,type = "dendrogram", lwd=2)
dev.off()
#Plot best solution lagoons
# png(filename = "C:/Users/timor/Nextcloud2/Timo/BODDENHECHT/Chapter 2/Stats/Niche analysis/Figures/Year_3_Sr_d18O_centroids.jpg", width = 2400, height = 800)
plot(clust_B$k_3, type="dendrogram", lwd=2)+
  theme(axis.text = element_text(size = 25, color="black"),
        axis.title = element_text(size = 25),
        plot.title = element_text(size = 25, hjust = 0.5))
#dev.off()

#Plot best solution Freshwater
plot(clust_F$k_3, type="centroid", linetype="solid", cex=2)+
  ylim(-2.5,2)+ggtitle(expression("Sr/"~delta^18~O~"cluster centroids"))+
  labs(x="transect cell", y="scaled value")+
  theme(axis.text = element_text(size = 25, color="black"),
        axis.title = element_text(size = 25),
        plot.title = element_text(size = 25, hjust = 0.5))

save(Fgroup,Bgroup,dataB, dataF, Bseries, Fseries, interpol, clust_B, clust_F,
     file = "Data/Pike/Adults_element_transects_all.RData")
```

```{r cluster assignment all, include=FALSE, eval=FALSE}
rm(list=ls())
load("Data/Pike/Adults_element_transects_all.RData")
#assign clusters to fish
fishassign_B2 <- data.frame(ID=names(Bseries), 
                            clust2=factor(clust_B$k_3@cluster, 
                                           levels = c(1:3), 
                                           labels = c("Int saline|cold",
                                                      "Low saline|cold",
                                                      "High saline|warm")))

fishassign_F2 <- data.frame(ID=names(Fseries), 
                            clust2=factor(clust_F$k_3@cluster, 
                                           levels = c(1:3), 
                                           labels = c("FW low saline|shift",
                                                      "FW low saline|cold",
                                                      "FW high saline|shift")))
#Join dtw clusters with pike data
Bgroup$area <- ifelse(Bgroup$area=="Marine", "GB", Bgroup$area)

fishassign_B <- Bgroup%>%
  group_by(ID)%>%
  transmute(ID=ID,
            capt=capt,
            area=as.factor(area),
            areaorder=case_when(area=="WRB"~1,
                                area=="NRB"~2,
                                area=="GB"~3,
                                area=="Freshwater"~4))%>%
  distinct()%>%
  inner_join(fishassign_B2, by="ID")%>%
  mutate(clust2=fct_relevel(clust2,
                            "Low saline|cold",
                            "Int saline|cold",
                            "High saline|warm"))

fishassign_F <- Fgroup%>%
  group_by(ID)%>%
  transmute(ID=ID,
            capt=capt,
            area=area)%>%
  distinct()%>%
  inner_join(fishassign_F2, by="ID")%>%
  mutate(clust2=fct_relevel(clust2,
                            "FW low saline|cold",
                            "FW low saline|shift",
                            "FW high saline|shift"))

#Fetch 3-year clusters
fishassign_F_3yr <- read.delim("Data/Pike/FW_clusters_3-year.txt", header = T,
                               stringsAsFactors = F, dec = ".", sep = "\t")

fishassign_B_3yr <- read.delim("Data/Pike/Bodden_clusters_3-year.txt", header = T,
                               stringsAsFactors = F, dec = ".", sep = "\t")

#join with all data to test cluster retention
fishassign_testB <- fishassign_B%>%left_join(fishassign_B_3yr, by="ID")%>%
  drop_na()%>%
  transmute(ID=ID,
            clust_all=clust2.x,
            clust_3=clust2.y,
            correct.assign=case_when(clust_all==clust_3~1,
                                     clust_all!=clust_3~0))

fishassign_testF <- fishassign_F%>%left_join(fishassign_F_3yr, by="ID")%>%
  drop_na()%>%
  transmute(ID=ID,
            clust_all=clust2.x,
            clust_3=clust2.y,
            correct.assign=case_when(clust_all==clust_3~1,
                                     clust_all!=clust_3~0))

write.table(fishassign_B, "Data/Pike/Bcluster_all.txt", row.names = F, sep = "\t",
            dec = ".")
write.table(fishassign_F, "Data/Pike/Fcluster_all.txt", row.names = F, sep = "\t",
            dec = ".")

save(Fgroup,Bgroup,dataB, dataF, Bseries, Fseries, interpol, clust_B, clust_F,
     fishassign_B2, fishassign_F2,
     file = "Data/Pike/Adults_element_transects_all.RData")
```

```{r plot Bodden proportions all, eval=FALSE}
mypallette <- viridis::viridis(3, direction = -1)

#Plot Bodden proportions

#png(filename = "C:/Users/timor/Nextcloud2/Timo/BODDENHECHT/Chapter 2/Stats/Niche analysis/Figures/Clusterassign.jpg", width = 2400, height = 800)
ggplot(fishassign_B, aes(reorder(area, areaorder), fill=clust2))+
  geom_bar(position = "fill", width = .5)+theme_minimal()+
  labs(x="", y="proportion", fill="assigned cluster")+
  scale_fill_manual(breaks=c("Low saline|cold",
                             "Int saline|cold",
                             "High saline|warm"), 
                    values = mypallette)+
  theme(axis.text.y = element_text(size = 25, color = "black"),
        axis.text.x = element_text(size = 25, color = "black"),
        axis.title = element_text(size = 25),
        legend.text = element_text(size = 25),
        legend.title = element_text(size = 25),
        legend.position = "top")
#dev.off()

#Plot FW proportions
ggplot(fishassign_F, aes(area, fill=clust2))+
  geom_bar(position = "fill", width = .5)+theme_minimal()+
  labs(x="", y="proportion", fill="assigned cluster")+
  scale_fill_manual(breaks=c("FW low saline|cold",
                             "FW high saline|warm"), 
                    values = mypallette)+
  theme(axis.text.y = element_text(size = 25, color = "black"),
        axis.text.x = element_text(size = 25, color = "black"),
        axis.title = element_text(size = 25),
        legend.text = element_text(size = 25),
        legend.title = element_text(size = 25),
        legend.position = "right")
```

```{r table of poportions, include=FALSE, eval=FALSE}
Allpike <- rbind(fishassign_B, fishassign_F)

WRBpike <- Allpike%>%filter(area=="WRB")
NRBpike <- Allpike%>%filter(area=="NRB")
GBpike <- Allpike%>%filter(capt=="GB")
FWpike <- Allpike%>%filter(area=="Freshwater")
Props <- data.frame(Ecotype=c("Lagoon low S, cold temperature",
                              "Lagoon med S, cold temperature",
                              "Lagoon high S, warm temperature",
                              "Freshwater resident, cold temperature",
                              "Freshwater migrant, warm temperature"),
                    WRB=paste0(round(summary(WRBpike$clust2)/nrow(WRBpike)*100,1),
                               "%"),
                    NRB=paste0(round(summary(NRBpike$clust2)/nrow(NRBpike)*100,1),
                               "%"),
                    GB=paste0(round(summary(GBpike$clust2)/nrow(GBpike)*100,1),
                              "%"),
                    Tributary=paste0(round(summary(FWpike$clust2)/nrow(FWpike)*100,
                                           1),"%"),
                    Total=paste0(round(summary(Allpike$clust2)/nrow(Allpike)*100,
                                           1),"%"))

Propstable <- Props%>%flextable()%>%
  set_caption("Proportions of ecotypes per sampling area")%>%
  set_table_properties(width = 0.99, layout = "autofit")%>%
  theme_vanilla()%>%
  align(j=c(2:5), align = "right")%>%
  vline(j=1)

#save as docx
save_as_docx(Propstable, path = "Tables/Proportions_Ecotypes.docx")
```

```{r dtw graphics lagoon, include=FALSE, eval=FALSE}
load("Data/Pike/Adults_element_transects_all.RData")

Bgroup.clus <- Bgroup%>%inner_join(fishassign_B2, by="ID")
Fgroup.clus <- Fgroup%>%inner_join(fishassign_F2, by="ID")

Groupall <- rbind(Bgroup.clus, Fgroup.clus)

agebreaks <- Groupall%>%group_by(ID, year)%>%
  summarise(yeardist=max(dist))%>%
  ungroup()%>%group_by(year)%>%
  mutate(mean.yeardist=mean(yeardist))

agebreaks.num <- unique(agebreaks$mean.yeardist)
agebreaks.label <- as.character(seq(1,11,1))

mypallette <- viridis::viridis(6, direction = 1)

A <- ggplot(Bgroup.clus[Bgroup.clus$clust2=="High saline|warm",])+
  geom_line(aes(dist, Sr*1000, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, Sr*1000), color="black", fill=mypallette[1], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(0, 7.5)+
  xlim(0,2100)+
  labs(x="", y=expression(bold("Sr/Ca (mg/g)")))+
  theme(legend.position = "none", 
        panel.grid.major.y = element_line(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(15,1,-27.5,-5)),
        axis.text.x = element_text(color = "white"),
        axis.text.y = element_text(color = "black", face = "bold", size = 8),
        axis.ticks.x = element_line(colour = "transparent"),
        axis.title.y = element_text(size = 8, margin = margin(r=10)))+
  coord_cartesian(clip = "off")+
  annotation_custom(grob = text_grob(label = "FW high S, thermal shift (N=9)",
                                     face = "bold", size = 8),
                    ymin = 8.5, ymax = 8.5, xmin = 1050, xmax = 1050)

B <- ggplot(Bgroup.clus[Bgroup.clus$clust2=="Int saline|cold",])+
  geom_line(aes(dist, Sr*1000, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, Sr*1000), color="black", fill=mypallette[2], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(0, 7.5)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(15,1,-27.5,-5)),
        axis.text.x = element_text(color = "white"),
        axis.ticks.x = element_line(colour = "transparent"))+
  coord_cartesian(clip = "off")+
  annotation_custom(grob = text_grob(label = "Int. S, thermal cold (N=15)",
                                     face = "bold", size = 8),
                    ymin = 8.5, ymax = 8.5, xmin = 1050, xmax = 1050)

C <- ggplot(Bgroup.clus[Bgroup.clus$clust2=="Low saline|cold",])+
  geom_line(aes(dist, Sr*1000, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, Sr*1000), color="black", fill=mypallette[3], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(0, 7.5)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(15,1,-27.5,-5)),
        axis.text.x = element_text(color = "white"),
        axis.ticks.x = element_line(colour = "transparent"))+
  coord_cartesian(clip = "off")+
  annotation_custom(grob = text_grob(label = "Low S, thermal shift (N=19)",
                                     face = "bold", size = 8),
                    ymin = 8.5, ymax = 8.5, xmin = 1050, xmax = 1050)

A1 <- ggplot(Bgroup.clus[Bgroup.clus$clust2=="High saline|warm",])+
  geom_line(aes(dist, d18O_res, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, d18O_res), color="black", fill=mypallette[1], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(-3, 3)+
  xlim(0,2100)+
  labs(x="", 
       y=expression(bold("scaled"~delta^18*"O"~("VPDB \u2030"))))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(1,1,-15,1)),
        axis.text.x = element_text(color = "black", face = "bold", size = 8),
        axis.text.y = element_text(color = "black", face = "bold", size = 8),
        axis.title.y = element_text(size = 8, margin = margin(r=10)))+
  coord_cartesian(clip = "off")+
  geom_segment(x=-330, y=0, xend=-330, yend=3, 
               lineend = "butt", linejoin = "mitre",
               size=2, arrow = arrow(length = unit(0.18, "inches")),
               color="#66CCCC")+
  annotation_custom(grob = text_grob(label = "cold", 
                                     rot = 90, face = "bold", size = 8),
                                     ymin=0, ymax=2,
                                     xmin=-335, xmax=-335)+
  geom_segment(x=-330, y=0, xend=-330, yend=-3, 
               lineend = "butt", linejoin = "mitre",
               size=2, arrow = arrow(length = unit(0.18, "inches")),
               color="#FF6666")+
  annotation_custom(grob = text_grob(label = "warm", 
                                     rot = -90, face = "bold", size = 8),
                                     ymin=0, ymax=-2,
                                     xmin=-325, xmax=-325)

B1 <- ggplot(Bgroup.clus[Bgroup.clus$clust2=="Int saline|cold",])+
  geom_line(aes(dist, d18O_res, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, d18O_res), color="black", fill=mypallette[2], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(-3,3)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(1,1,-15,1)),
        axis.text.x = element_text(color = "black", face = "bold", size = 8))+
  coord_cartesian(clip = "off")

C1 <- ggplot(Bgroup.clus[Bgroup.clus$clust2=="Low saline|cold",])+
  geom_line(aes(dist, d18O_res, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, d18O_res), color="black", fill=mypallette[3], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(-3,3)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(1,1,-15,1)),
        axis.text.x = element_text(color = "black", face = "bold", size = 8))+
  coord_cartesian(clip = "off")

Plot <- ggarrange(A,B,C,A1,B1,C1, 
          nrow = 2, ncol = 3, 
          widths = c(1,1,1),
          heights = c(1.5,1.5),
          align = "v",
          labels = c("a","b","c"),
          label.x = .1,
          label.y = 1.03)

png(filename = "Figures/Life-history-plots-lagoon.png", 
    width = 5000, height = 2000, res = 600)
annotate_figure(Plot,
                bottom = text_grob(expression(bold("Distance from core"~(mu*"m"))),
                                   size = 8, vjust = 0.7, hjust = 0.35),
                top = text_grob(expression(bold("Lagoon pike life histories")),
                                size = 15, hjust = 1.6),
                fig.lab.size = 5,
                fig.lab.face = "bold")
dev.off()
```

```{r dtw graphics FW, include=FALSE, eval=FALSE}
D <- ggplot(Fgroup.clus[Fgroup.clus$clust2=="FW high saline|shift",])+
  geom_line(aes(dist, Sr*1000, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, Sr*1000), color="black", fill=mypallette[4], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(0, 7.5)+
  xlim(0,2100)+
  labs(x="", y=expression(bold("Sr/Ca (mg/g)")))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_text(color = "black", face = "bold", size = 8),
        axis.ticks.y = element_blank(),
        axis.title.y = element_text(size = 8, margin = margin(r=10)),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(15,1,-27.5,-5)),
        axis.text.x = element_text(color = "white"),
        axis.ticks.x = element_line(colour = "transparent"))+
  coord_cartesian(clip = "off")+
  annotation_custom(grob = text_grob(label = "FW high S, thermal shift (N=9)",
                                     face = "bold", size = 8),
                    ymin = 8.5, ymax = 8.5, xmin = 1050, xmax = 1050)

E <- ggplot(Fgroup.clus[Fgroup.clus$clust2=="FW low saline|cold",])+
  geom_line(aes(dist, Sr*1000, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, Sr*1000), color="black", fill=mypallette[5], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(0, 7.5)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(15,1,-27.5,-5)),
        axis.text.x = element_text(color = "white"),
        axis.ticks.x = element_line(colour = "transparent"))+
  coord_cartesian(clip = "off")+
  annotation_custom(grob = text_grob(label = "FW resident, thermal cold (N=4)",
                                     face = "bold", size = 8),
                    ymin = 8.5, ymax = 8.5, xmin = 1050, xmax = 1050)


F1 <- ggplot(Fgroup.clus[Fgroup.clus$clust2=="FW low saline|shift",])+
  geom_line(aes(dist, Sr*1000, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, Sr*1000), color="black", fill=mypallette[6], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(0, 7.5)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(15,1,-27.5,-5)),
        axis.text.x = element_text(color = "white"),
        axis.ticks.x = element_line(colour = "transparent"))+
  coord_cartesian(clip = "off")+
  annotation_custom(grob = text_grob(label = "FW resident, thermal shift (N=4)",
                                     face = "bold", size = 8),
                    ymin = 8.5, ymax = 8.5, xmin = 1050, xmax = 1050)

D1 <- ggplot(Fgroup.clus[Fgroup.clus$clust2=="FW high saline|shift",])+
  geom_line(aes(dist, d18O_res, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, d18O_res), color="black", fill=mypallette[4], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(-3,3)+
  xlim(0,2100)+
  labs(x="", 
       y=expression(bold("scaled"~delta^18*"O"~("VPDB \u2030"))))+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_text(color = "black", face = "bold", size = 8),
        axis.ticks.y = element_blank(),
        axis.title.y = element_text(size = 8, margin = margin(r=10)),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(1,1,-15,1)),
        axis.text.x = element_text(color = "black", face = "bold", size = 8))+
  coord_cartesian(clip = "off")+
  geom_segment(x=-330, y=0, xend=-330, yend=3, 
               lineend = "butt", linejoin = "mitre",
               size=2, arrow = arrow(length = unit(0.18, "inches")),
               color="#66CCCC")+
  annotation_custom(grob = text_grob(label = "cold", 
                                     rot = 90, face = "bold", size = 8),
                                     ymin=0, ymax=2,
                                     xmin=-335, xmax=-335)+
  geom_segment(x=-330, y=0, xend=-330, yend=-3, 
               lineend = "butt", linejoin = "mitre",
               size=2, arrow = arrow(length = unit(0.18, "inches")),
               color="#FF6666")+
  annotation_custom(grob = text_grob(label = "warm", 
                                     rot = -90, face = "bold", size = 8),
                                     ymin=0, ymax=-2,
                                     xmin=-325, xmax=-325)

E1 <- ggplot(Fgroup.clus[Fgroup.clus$clust2=="FW low saline|cold",])+
  geom_line(aes(dist, d18O_res, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, d18O_res), color="black", fill=mypallette[5], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(-3,3)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(1,1,-15,1)),
        axis.text.x = element_text(color = "black", face = "bold",size = 8))+
  coord_cartesian(clip = "off")

F2 <- ggplot(Fgroup.clus[Fgroup.clus$clust2=="FW low saline|shift",])+
  geom_line(aes(dist, d18O_res, group=ID), color="grey", size=.3, alpha=.8)+
  geom_smooth(aes(dist, d18O_res), color="black", fill=mypallette[6], 
              alpha=1, size=.3, method = "gam")+
  scale_color_viridis_d()+
  theme_classic()+
  ylim(-3,3)+
  xlim(0,2100)+
  labs(x="")+
  theme(legend.position = "none",
        panel.grid.major.y = element_line(),
        axis.line.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),
        panel.border = element_rect(fill = NA, size = 1),
        plot.margin = margin(c(1,1,-15,1)),
        axis.text.x = element_text(color = "black", face = "bold",size = 8))+
  coord_cartesian(clip = "off")

Plot <- ggarrange(D,E,F1,D1,E1,F2, 
          nrow = 2, ncol = 3, 
          widths = c(1,1,1),
          heights = c(1.5,1.5),
          align = "v",
          labels = c("d","e","f"),
          label.x = .1,
          label.y = 1.03)

png(filename = "Figures/Life-history-plots_FW.png", 
    width = 5000, height = 2000, res = 600)
annotate_figure(Plot,
                bottom = text_grob(expression(bold("Distance from core"~(mu*"m"))),
                                   size = 8, vjust = 0.7, hjust = 0.35),
                top = text_grob(expression(bold("Tributary pike life histories")),
                                size = 15, hjust = 1.5),
                fig.lab.size = 5,
                fig.lab.face = "bold")
dev.off()
```

## Setup and cleanup of data for mixed models
```{r LUNG cleanup for GLMM, include=FALSE, eval=FALSE}
# Script to read in and clean up LUNG data tables
rm(list = ls())

# Read in data
LUNGdata_coast <- read.delim("Data/Environment/Lungdata_all_coast_2005-2020.txt",
                             header = T, stringsAsFactors = F, 
                             sep = "\t", dec = ".")
LUNGdata_rivers <- read.delim("Data/Environment/Lungdata_all_rivers_2005-2020.txt",
                             header = T, stringsAsFactors = F, 
                             sep = "\t", dec = ".")

#Prepare data frames
LUNGdata_coast_clean <- LUNGdata_coast %>%
  transmute(id = MstNr,
            name = Messstelle,
            water_body = Gewsser,
            datetime = DATUM_Uhrzeit,
            parameter = Param_kurz,
            parameter2 = Parameter,
            value = WERT,
            unit = Einheit,
            depth = TIEFE,
            Lat = HW_GEO,
            Long = RW_GEO,
            turbidity = SICHTTIEFE,
            type = "Coast")

LUNGdata_rivers <- LUNGdata_rivers %>%
  transmute(id = MS_NR,
            name = Messstelle,
            water_body = Gewsser,
            datetime = DATUM_Uhrzeit,
            parameter = Param_kurz,
            parameter2 = Parameter,
            value = WERT,
            unit = Einheit,
            depth = NA,
            HW = HW,
            RW = RW,
            turbidity = NA)

# Convert from Gau-Krueger to WGS84 coordinates--------------------------------
LUNGdata_rivers_GK <- data.frame(cbind(LUNGdata_rivers, "X_GK" = LUNGdata_rivers$RW,
                                       "Y_GK" = LUNGdata_rivers$HW))

coordinates(LUNGdata_rivers_GK) <- c("X_GK", "Y_GK")
proj4string(LUNGdata_rivers_GK) <- CRS("+init=epsg:5650")
LUNGdata_rivers_WGS84 <- spTransform(LUNGdata_rivers_GK, CRS("+init=epsg:4326"))

LUNGdata_rivers_WGS84 <- as.data.frame(LUNGdata_rivers_WGS84)

LUNGdata_rivers_clean <- LUNGdata_rivers_WGS84%>%
  transmute(id = id,
            name = name,
            water_body = water_body,
            datetime = datetime,
            parameter = parameter,
            parameter2 = parameter2,
            value = value,
            unit = unit,
            depth = depth,
            Lat = Y_GK,
            Long = X_GK,
            turbidity = turbidity, 
            type = "Freshwater")

# Filter for variables of interest before converting to wide and join-----------
LUNG_sal_temp_coast <- LUNGdata_coast_clean %>%
  filter(parameter == "W-T"|parameter2=="Wassertemperatur"|
           parameter == "SAL"|parameter2 == "Salzgehalt"|
           parameter == "P"|parameter2 == "Phophor, gesamt")%>%
  transmute(id = id,
            name = name,
            waterbody = water_body,
            date = lubridate::as_date(parse_date_time(datetime, orders = "ymd_HMS")),
            day = lubridate::day(parse_date_time(datetime, orders = "ymd_HMS")),
            month = lubridate::month(parse_date_time(datetime, orders = "ymd_HMS")),
            year = lubridate::year(parse_date_time(datetime, orders = "ymd_HMS")),
            parameter = parameter,
            value = value,
            depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = "LUNG",
            type = type)

LUNG_sal_temp_rivers <- LUNGdata_rivers_clean %>%
  filter(parameter == "W-T"|parameter2=="Wassertemperatur"|
           parameter == "SAL"|parameter2 == "Salzgehalt"|
           parameter == "P"|parameter2 == "Phophor, gesamt")%>%
  transmute(id = id,
            name = name,
            waterbody = water_body,
            date = lubridate::as_date(parse_date_time(datetime, orders = "ymd_HMS")),
            day = lubridate::day(parse_date_time(datetime, orders = "ymd_HMS")),
            month = lubridate::month(parse_date_time(datetime, orders = "ymd_HMS")),
            year = lubridate::year(parse_date_time(datetime, orders = "ymd_HMS")),
            parameter = parameter,
            value = value,
            depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = "LUNG",
            type = type)

#insert NAs for later means
LUNG_sal_temp_rivers <- LUNG_sal_temp_rivers%>%
  group_by(name, year, month, parameter)%>%
  summarize(id = id,
            name = name,
            waterbody = waterbody,
            month = month,
            year = year,
            parameter = parameter,
            value = mean(value, na.rm = T),
            Lat = Lat,
            Long = Long,
            turbidity=turbidity,
            measurement = measurement,
            type = type)%>%
  ungroup()%>%
  distinct()%>%
  pivot_wider(names_from = month, values_from = value)

LUNG_sal_temp_rivers <- LUNG_sal_temp_rivers%>%
  pivot_longer(cols = c(11:22), names_to = "month",
               values_to = "value", values_drop_na = F)

# remove double rows before converting to wide
LUNG_sal_temp_coast <- LUNG_sal_temp_coast[-c(11296, 11298, 563, 564),]

LUNG_sal_temp_coast <- LUNG_sal_temp_coast%>%
  group_by(name, year, month, parameter)%>%
  summarize(id = id,
            name = name,
            waterbody = waterbody,
            month = month,
            year = year,
            parameter = parameter,
            value = mean(value, na.rm = T),
            Lat = Lat,
            Long = Long,
            turbidity=turbidity,
            measurement = measurement,
            type = type)%>%
  ungroup()%>%
  distinct()%>%
  pivot_wider(names_from = month, values_from = value)

LUNG_sal_temp_coast <- LUNG_sal_temp_coast%>%
  pivot_longer(cols = c(11:22), names_to = "month",
               values_to = "value", values_drop_na = F)

# convert to wide
LUNG_sal_temp_coast <- spread(LUNG_sal_temp_coast, parameter, value)
head(LUNG_sal_temp_coast)
LUNG_sal_temp_rivers <- spread(LUNG_sal_temp_rivers, parameter, value)
head(LUNG_sal_temp_rivers)
LUNG_sal_temp_rivers$SAL <- 0

LUNGdata_all <- rbind(LUNG_sal_temp_coast, LUNG_sal_temp_rivers)
names(LUNGdata_all)[13] <- paste("WT")

# Add ID numbers
LUNGdata_all <- LUNGdata_all %>%
  transmute(id = case_when(name %in% "AW1 Trockenort" ~"0111030108",
                           waterbody %in% "Graben 44" ~"0103070022",
                           name %in% "DB6 Barth oe." ~"0103050603",
                           name %in% "DB2 Sundische Wiese" ~"0103050208",
                           name %in% "DB1 Pramort" ~"0103050101",
                           name %in% "GS Gellenstrom Hiddensee w." ~"0103070503",   
                           name %in% "RB2 Vitte oe." ~"0112190202",
                           name %in% "RB3 Bugspitze s." ~"0112190309",
                           name %in% "RB1 Schaprode w." ~"0112400185",
                           name %in% "KB90 Fahrwasser I.Libitz w." ~"0103059085",
                           name %in% "S66 Stralsund" ~"0109016609",
                           name %in% "RB6 Wittower Faehre oe." ~"0112280603",
                           name %in% "RB9 Glowe sw." ~"0112390909",
                           name %in% "RB10 Lietzow n." ~"0112391004",
                           name %in% "RB15 Buschvitz oe." ~"0112391500",
                           name %in% "GB3 Daenische Wiek n." ~"0105010306",
                           name %in% "GB2 I.Vilm s." ~"0105010285",
                           name %in% "GB19 Zentralbereich" ~"0105011907",
                           name %in% "GB7 Struck" ~"0105010701",
                           name %in% "GB10 Ruden s." ~"0111021001",
                           name %in% "O133 suedl. Greifsw. Oie" ~"0111071308",
                           name %in% "P20 Peenemuende s." ~"0111032085",
                           name %in% "P42 Wolgast s." ~"0111034208",
                           name %in% "P48 Lassan" ~"0111034806",
                           TRUE ~ id),
            name = name,
            waterbody = waterbody,
            #date = date,
            #day = day,
            month = month,
            year = year,
            #depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = measurement,
            type = type,
            SAL = SAL,
            WT = WT,
            P=P)

#Must be zero:
unique(ifelse(is.na(LUNGdata_all$id)==T, 1, 0))

# join in 2021 data-------------------------------------------------------------

LUNGdata_coast_21 <- read.delim("Data/Environment/LUNG-Daten_all_coast_2021.txt",
                                header = T, stringsAsFactors = F, 
                                sep = "\t", dec = ".")
#clean
LUNGdata_coast_21 <- LUNGdata_coast_21 %>%
  transmute(id = paste0(0, PN.Stellennr.),
            date = lubridate::as_date(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            day = lubridate::day(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            month = lubridate::month(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            year = lubridate::year(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            depth = case_when(Tiefeninformation %in% "Grundnhe" ~ "bottom",
                              TRUE ~ "surface"),
            parameter = Parameter,
            value = Endergebnis)%>%
  filter(parameter == "Wassertemperatur"|
           parameter == "Salzgehalt"|
           parameter == "Gesamt P"|
           parameter == "Sichttiefe")

#insert NAs
LUNGdata_coast_21 <- LUNGdata_coast_21%>%
  group_by(id, year, month, parameter)%>%
  summarize(id = id,
            month = month,
            year = year,
            parameter = parameter,
            value = mean(as.numeric(value), na.rm = T))%>%
  ungroup()%>%
  distinct()%>%
  pivot_wider(names_from = month, values_from = value)

LUNGdata_coast_21 <- LUNGdata_coast_21%>%
  pivot_longer(cols = c(4:15), names_to = "month",
               values_to = "value", values_drop_na = F)

LUNGdata_coast_21 <- rbind(LUNGdata_coast_21[LUNGdata_coast_21$year!=2022,],
                           na.omit(LUNGdata_coast_21[LUNGdata_coast_21$year==2022,]))


#wide
LUNGdata_coast_21 <- spread(LUNGdata_coast_21, parameter, value)
head(LUNGdata_coast_21)

LUNGdata_coast_21 <- LUNGdata_coast_21 %>%
  transmute(id = id,
            #date = date,
            #day = day,
            month = month,
            year = year,
            #depth = depth,
            SAL = Salzgehalt,
            WT = Wassertemperatur,
            P_total=`Gesamt P`,
            trbidity=Sichttiefe)

# for loop to complement rows
IDstation <- unique(LUNGdata_coast_21$id)
df <- data.frame()
for (i in 1:length(IDstation)) {
  nm <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]), 
                                 "name"]), NA)))
  wb <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]),
                                 "waterbody"]), NA)))
  Lat <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]), "Lat"]), NA)))
  Long <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]), 
                                 "Long"]), NA)))
  df <- rbind(df, data.frame(nm, wb, Lat, Long))
}

#add missing columns
LUNGdata_coast_21 <- cbind(LUNGdata_coast_21, df)
#LUNGdata_coast_21$turbidity <- NA
LUNGdata_coast_21$type <- "Coast"
LUNGdata_coast_21$measurement <- "LUNG"

LUNGdata_coast_21 <- LUNGdata_coast_21 %>%
  transmute(id = id,
            name = nm,
            waterbody = wb,
            #date = date,
            #day = day,
            month = month,
            year = year,
            #depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = trbidity,
            measurement = measurement,
            type = type,
            SAL = SAL,
            WT = WT,
            P=P_total)

LUNGdata_all <- data.frame(rbind(LUNGdata_all, LUNGdata_coast_21))

LUNGdata_all <- LUNGdata_all%>%
  transmute(waterbody = case_when(name %in% "AW1 Trockenort" ~"P",
                                  name %in% "DB1 Pramort" ~"BAT",
                                  name %in% "DB10 Bodstedt n." ~"BoB",
                                  name %in% "DB16 Saal nw." ~"SaB",
                                  name %in% "DB2 Sundische Wiese" ~"BAT",
                                  name %in% "DB6 Barth oe." ~"BAT",
                                  name %in% "GB10 Ruden s." ~"GB",
                                  name %in% "GB19 Zentralbereich" ~"GB",
                                  name %in% "GB2 I.Vilm s." ~"GB",
                                  name %in% "GB3 Daenische Wiek n." ~"GB",
                                  name %in% "GB7 Struck" ~"GB",
                                  name %in% "GS Gellenstrom Hiddensee w." 
                                  ~"Baltic",
                                  name %in% "KB90 Fahrwasser I.Libitz w." ~"WRB",
                                  name %in% "O133 suedl. Greifsw. Oie" ~"Baltic",
                                  name %in% "P20 Peenemuende s." ~"P",
                                  name %in% "P42 Wolgast s." ~"P",
                                  name %in% "P48 Lassan" ~"P",
                                  name %in% "RB1 Schaprode w." ~"WRB",
                                  name %in% "RB10 Lietzow n." ~"NRB",
                                  name %in% "RB15 Buschvitz oe." ~"KJB",
                                  name %in% "RB2 Vitte oe." ~"WRB",
                                  name %in% "RB3 Bugspitze s." ~"NRB",
                                  name %in% "RB6 Wittower Faehre oe." ~"NRB",
                                  name %in% "RB9 Glowe sw."~"NRB",
                                  name %in% "S66 Stralsund" ~"WRB",
                                  name %in% "Barth" ~"Barthe",
                                  name %in% "Klein Damitz" ~"Bandycksgraben",
                                  name %in% "Wolgast" ~"Ziese",
                                  name %in% "Neuendorf" ~"Sehrowbach",
                                  name %in% "Kemnitz" ~"Ziese",
                                  TRUE~name),
            id = id,
            name = name,
            month = month,
            year = year,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = measurement,
            type = type,
            SAL = SAL,
            WT = WT,
            P=P)

Lungdata <- LUNGdata_all%>%
  group_by(waterbody, year)%>%
  summarise(type=type,
            turbidity=mean(turbidity, na.rm=T),
            SAL=mean(SAL, na.rm=T),
            WT=mean(WT, na.rm=T),
            P=mean(P, na.rm=T))%>%
  distinct()

# save file
write.table(Lungdata, 
            file = "Data/LUNGdata.txt", 
            sep = "\t", dec = ".", row.names = F)


```

```{r get clean version of growth data, include=FALSE, eval=FALSE}

rm(list = ls())

#read in pike data
fishdata <- read.delim("Data/Pike/Scales_Oto_data.txt", sep = "\t", dec = ".", 
                       header = T, stringsAsFactors = F)
names(fishdata) <- tolower(names(fishdata))

#load in age readings
pike_increments_B <- read.delim("Data/Pike/Otolith_combo_round2.txt", 
                              header = T, stringsAsFactors = F)
names(pike_increments_B) <- tolower(names(pike_increments_B))

pike_increments_Ana <- read.delim("Data/Pike/combined_anadromous.txt",
                                  header = T, stringsAsFactors = F)
names(pike_increments_Ana) <- tolower(names(pike_increments_Ana))

#read in decoder
decoder_B <- read.delim("Data/Pike/Decoding_file_05-10-21_BH-00670-90307_Otoliths.txt", header = T, stringsAsFactors = F)

names(decoder_B) <- tolower(names(decoder_B))

decoder_Ana <- read.delim("Data/Pike/Decoding_file_12-10-21_BH-00670-90307_Otoliths.txt", header = T, stringsAsFactors = F)

names(decoder_Ana) <- tolower(names(decoder_Ana))

pike_increments_B$random_id <- pike_increments_B$sample
pike_increments_Ana$random_id <- pike_increments_Ana$sample

#decode
pike_increments_B <- pike_increments_B %>% inner_join(decoder_B, by = "random_id")
pike_increments_Ana <- pike_increments_Ana%>%inner_join(decoder_Ana, by="random_id")

pike_increments <- rbind(pike_increments_Ana, pike_increments_B)

pike_inc <- pike_increments %>% inner_join(fishdata, by="id")%>%
  transmute(ID=id,
            age=age,
            cohort=cohort,
            capt=area,
            TL=tl,
            weigth=weight,
            sex=sex,
            date=lubridate::date(parse_date_time(date, "dmy")),
            core=core,
            i=i,
            year=year,
            increment=increment,
            quality=quality)

#convert inc to rad
IDpike <- unique(pike_inc$ID)
rad <- NULL
for (i in 1:length(IDpike)) {
  d <- cumsum(coalesce(pike_inc[which(pike_inc$ID == IDpike[i]), "increment"], 0)) + pike_inc[which(pike_inc$ID == IDpike[i]), "increment"]*0
 rad <- c(rad, d)
}

pike_inc$rad <- rad

write.table(pike_inc, file = "Data/Pike/Oto_increment_data_with_rad.txt",
            sep = "\t", dec = ".", row.names = F)
```

```{r join growth measurements with cluster, include=FALSE, eval=FALSE}

#rm(list = ls())

#read in data on increment widths
pike_inc <- read.delim(file = "Data/Pike/Oto_increment_data_with_rad.txt",
            sep = "\t", dec = ".", header = T, stringsAsFactors = F)

#get clustering results
fishassign_B <- read.delim(file = "Data/Pike/Bcluster_all.txt", 
                           header = T, stringsAsFactors = F, dec = ".", sep = "\t")
fishassign_F <- read.delim(file = "Data/Pike/Fcluster_all.txt", 
                           header = T, stringsAsFactors = F, dec = ".", sep = "\t")

allpike <- rbind(fishassign_B[,c(1:3,5)], fishassign_F)

#join increment data with clustering results
pikedat <- allpike%>%
  transmute(ID=ID,
            area=area,
            clust=case_when(clust2 == "High saline|warm"~"HighS|Tconstant",
                            clust2 == "Int saline|cold"~"IntS|Tcold",
                            clust2 == "Low saline|cold"~"LowS|Tshift",
                            clust2 == "FW high saline|shift"~"FWHighS|Tshift",
                            clust2 == "FW low saline|cold"~"FWresident|Tcold",
                            clust2 == "FW low saline|shift"~"FWresident|Tshift"))%>%
  inner_join(pike_inc, by = "ID")

write.table(pikedat, "Data/Pike/Growthdata_clusters.txt", row.names = F,
            sep = "\t", dec = ".")
```

```{r shape data, include=FALSE, eval=FALSE}
#Script to read cleaned environmental data and combine it with pike data
rm(list = ls())

Lungdata <- read.delim("Data/Environment/LUNGdata.txt", header = T, 
                       stringsAsFactors = F, sep = "\t", dec = ".")

pikedat <- read.delim("Data/Pike/Growthdata_clusters.txt", 
                        sep = "\t", dec = ".", header = T, stringsAsFactors = F)


#Clean up data frames
pikedata <- pikedat%>%
  transmute(ID=as.character(ID),
            area=area,
            capt=capt,
            clust=as.factor(clust),
            age=as.integer(age),
            cohort=as.integer(cohort),
            weight=weigth,
            TL=as.numeric(TL),
            sex=as.factor(sex),
            lifeyear=factor(i, levels = c(1:13), labels = c(1:13)),
            year=year,
            inc=as.numeric(increment),
            rad=as.numeric(rad))

#Bind together

oto_lowres <- read.delim("Data/Pike/Oto_LA-to-d18O_interpolation.txt",
                         header = T, dec = ".", sep = "\t",
                         stringsAsFactors = F)

oto_years <- oto_lowres%>%
  group_by(ID,year)%>%
  summarise(ID=ID,
            lifeyear=as.factor(year),
            d18O_mean=mean(d18O, na.rm=T),
            res_mean=mean(res, na.rm=T),
            Sr_mean=mean(Sr, na.rm=T),
            d18O_min=min(d18O, na.rm=T),
            res_min=min(res, na.rm=T),
            Sr_min=min(Sr, na.rm=T),
            d18O_max=max(d18O, na.rm=T),
            res_max=max(res, na.rm=T),
            Sr_max=max(Sr, na.rm=T))%>%
  drop_na()

pikedata1 <- pikedata%>%inner_join(oto_years, by=c("ID", "lifeyear"))%>%
  transmute(ID=ID,
            waterbody=area,
            capt=capt,
            clust=clust,
            age=age,
            cohort=cohort,
            weight=weight,
            TL=TL,
            sex=sex,
            lifeyear=lifeyear,
            year=year.x,
            inc=inc,
            rad=rad,
            d18O_mean=d18O_mean,
            d18O_max=d18O_max,
            d18O_min=d18O_min,
            res_mean=res_mean,
            res_max=res_max,
            res_min=res_min,
            Sr_mean=Sr_mean,
            Sr_max=Sr_max,
            Sr_min=Sr_min)%>%
  drop_na(inc,rad,year)%>%
  distinct()

pikedata2 <- pikedata1%>%left_join(Lungdata, by=c("waterbody", "year"))

write.table(pikedata2, 
            file = "Data/Pike/Pikedata.txt", 
            sep = "\t", dec = ".", row.names = F)
```

## Prepare data for modelling
```{r project start, include=FALSE, message=FALSE, warning=FALSE, echo=FALSE, eval=FALSE}
rm(list = ls())

pikes <- read.delim("Data/Pike/Pikedata.txt", header = T, stringsAsFactors = F,
                    sep = "\t", dec = ".")

pikes$clust

head(pikes)
tail(pikes)
str(pikes)

#Prepare data frame with factors and scale+center element data
pikes2 <- pikes%>%
  transmute(ID=ID,
            waterbody=as.factor(waterbody),
            clust=as.factor(clust),
            sex=as.factor(sex),
            lifeyear=lifeyear,
            inc=inc,
            res_mean=as.numeric(scale(res_mean)),
            Sr_mean=as.numeric(scale(Sr_mean)),
            visibility=as.numeric(scale(turbidity)),
            Sal=as.numeric(scale(SAL)),
            WT=as.numeric(scale(WT)),
            P=as.numeric(scale(P)))

write.table(pikes2, "Data/Pike/Pikedata_model.txt", sep="\t", dec=".",
            row.names = F)

#Check
str(pikes2)
```

## Data exploration
```{r Exploration, include=FALSE, echo=FALSE, eval=FALSE, fig.height=6, fig.width=8}
#Exploration

par(mfrow=c(1,2))
dotchart(pikes2$inc, color = pikes2$clust, main = "Color = Ecotype(Cluster)")
dotchart(pikes2$inc, color = pikes2$sex, main = "Color = Sex")
```

```{r Exploration, include=FALSE, echo=FALSE, eval=FALSE, fig.height=5, fig.width=8}
par(mfrow=c(3,2))
boxplot(pikes2$inc~pikes2$lifeyear, ylab ="Growth increment", xlab = "Age")
boxplot(pikes2$inc~pikes2$clust, ylab ="Growth increment", xlab = "Ecotype")
boxplot(pikes2$inc~pikes2$sex, ylab ="Growth increment", xlab = "Sex")
plot(pikes2$inc~pikes2$res_mean, ylab ="Growth increment", xlab = "d18O")
plot(pikes2$inc~pikes2$Sr_mean, ylab ="Growth increment", xlab = "Sr")
plot(0, xaxt = 'n', yaxt = 'n', bty = 'n', pch = '', ylab = '', xlab = '')
```

```{r Exploration, include=FALSE, echo=FALSE, eval=FALSE, fig.height=5, fig.width=8}
par(mfrow = c(2,2))
hist(pikes2$inc, main = "", xlab = "Increment (um)")
hist(pikes2$res_mean, main = "", xlab = "d18O ratio")
hist(pikes2$Sr_mean, main = "", xlab = "Sr concentration")
plot(0, xaxt = 'n', yaxt = 'n', bty = 'n', pch = '', ylab = '', xlab = '')
```

## Initial model
$$log10(Inc) \sim Age*cluster+Age*d18Ores+Srmean+turbidity+salinity+WT+P+Sex+(1|Loc/ID)$$

```{r exclude random effect of ID, include=FALSE, eval=FALSE}
#Run model
pikemodel.1 <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                        Sr_mean+sex+(1|waterbody/ID), 
                      REML = T, data = pikes2)
summary(pikemodel.1)
#Random effects cannot be estimated as too low variance
#Model runs properly when excluding ID:
pikemodel.1.0 <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = T, data = pikes2)
summary(pikemodel.1.0)
```
 
## New model
$$log10(Inc) \sim Age*d18Ores+Age*cluster+Age^2+Srmean+Sex+(1|Location)$$

```{r Look at variance inflation factors, echo=TRUE, eval=FALSE}
#Look at variance inflation factors
pikemodel.1.0 <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = T, data = pikes2)

pike.vif <- vif(pikemodel.1.0)

barplot(pike.vif[,3], main = "VIF values", horiz = F, col = "darkgreen", ylim = c(0,6),
        las = 2)
abline(h = 5, lwd = 3, lty = 2, col="red")
```

## Log-likelihood ratio tests
```{r test random effects, echo=TRUE, eval=FALSE}
#Test model components
#Test random effects
rand(pikemodel.1.0)
```

```{r test effects age, echo=TRUE, eval=FALSE}
#Remove age quadratic term
pikemodel.1.0 <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = F, data = pikes2)

pikemodel.noage <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+
                      Sr_mean+sex+(1|waterbody), 
                      REML = F, data = pikes2)

anova(pikemodel.1.0, pikemodel.noage)
#age is significant
```

```{r test cluster effects, eval=FALSE}
pikemodel.noclust <- lmer(log10(inc)~lifeyear*res_mean+clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = F, data = pikes2)
anova(pikemodel.1.0, pikemodel.noclust)
#age*cluster is significant
```

```{r test effects d18O, echo=TRUE, eval=FALSE}
#Remove d18O
pikemodel.nores <- lmer(log10(inc)~lifeyear*clust+res_mean+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = F, data = pikes2)
anova(pikemodel.1.0, pikemodel.nores)
#relative d18O significant
```

```{r test effects Sr, echo=TRUE, eval=FALSE}
#Remove Sr
pikemodel.noSr <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      sex+(1|waterbody), 
                      REML = F, data = pikes2)
anova(pikemodel.1.0, pikemodel.noSr)
#Sr not significant
```

```{r test effects sex, echo=TRUE, eval=FALSE}
#Remove sex
pikemodel.nosex <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+(1|waterbody), 
                      REML = F, data = pikes2)
anova(pikemodel.1.0, pikemodel.nosex)
#sex is significant
```

## Results
```{r table, out.width="120%", dpi=300, echo=FALSE, eval=FALSE, message=FALSE}
summary(pikemodel.final)
tab_model(pikemodel.final, show.fstat = T, show.loglik = T, digits.re = 20)
```

## Model validation
```{r model validation, echo=FALSE, eval=FALSE}
#validation
pikemodel.final <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = T, data = pikes2)

pikes2$resid <- resid(pikemodel.final)

plot(pikemodel.final, xlab = "Fitted", ylab = "Residuals")
hist(pikes2$resid, main = "", xlab = "Residuals")

qqnorm(resid(pikemodel.final))
qqline(resid(pikemodel.final))


plot(pikes2$resid~pikes2$clust, ylab = "Residuals", xlab = "Cluster", las = 2)
plot(pikes2$resid~pikes2$sex, ylab = "Residuals", xlab = "Sex")
plot(pikes2$resid~pikes2$lifeyear, ylab = "Residuals", xlab = "Age")
plot(pikes2$resid~pikes2$res_mean, ylab = "Residuals", xlab = "d18O")
plot(pikes2$resid~pikes2$Sr_mean, ylab = "Residuals", xlab = "Sr concentration")

r.squaredGLMM(pikemodel.final)
```

## Figure main effects
```{r temperture effect figure, eval=FALSE}
pikes2 <- read.delim("Data/Pike/Pikedata_model.txt", header = T, 
                     stringsAsFactors = F, sep = "\t", dec = ".")

#factorize temperature
pikes2$agefact <- ifelse(pikes2$lifeyear<3, 2, 
                         ifelse(pikes2$lifeyear>2&pikes2$lifeyear<7, 1,
                                ifelse(pikes2$lifeyear>6, 3, NA)))

pikes2$agefact2 <- factor(pikes2$agefact,levels = c(2,1,3),
                                            labels = c("juvenile", "adult", 
                                                       "TL > 1 m"))

mypallette <- viridis::viridis(4, direction = -1)

#Temperature effect
Temp <- ggplot(pikes2, aes(res_mean, log(inc), color=agefact2))+
  geom_point(size=.5)+
  stat_smooth(method = "lm", fill="gray", fullrange = T, lwd=.8)+
  labs(x=expression(bold("scaled"~delta^18*"O"~("z-score"))), 
       y=expression(bold("log increment"~(mu*"m"))),
       color="ageclass")+
  scale_color_viridis_d()+
  theme_classic()+
  theme(panel.grid.major = element_line(),
        legend.position = c(.9,.9),
        legend.background = element_blank(),
        legend.box.background = element_rect(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.title.x = element_text(size = 10, face = "bold", 
                                    margin = margin(t=10)),
        axis.title.y = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 10, face = "bold"),
        legend.key.size = unit(.8,"line"))+
  coord_cartesian(clip = "off")+
  geom_segment(x=0, y=3.6, xend=2.5, yend=3.6, 
               lineend = "butt", linejoin = "mitre",
               size=2, arrow = arrow(length = unit(0.18, "inches")),
               color="#66CCCC")+
  annotation_custom(grob = text_grob(label = "cold", 
                                     rot = 0, face = "bold", size = 10),
                                     ymin=3.62, ymax=3.62,
                                     xmin=0, xmax=2.5)+
  geom_segment(x=0, y=3.6, xend=-2.5, yend=3.6, 
               lineend = "butt", linejoin = "mitre",
               size=2, arrow = arrow(length = unit(0.18, "inches")),
               color="#FF6666")+
  annotation_custom(grob = text_grob(label = "warm", 
                                     rot = -0, face = "bold", size = 10),
                                     ymin=3.62, ymax=3.62,
                                     xmin=0, xmax=-2.5)

png(filename = "Figures/Temperature_effects_growth.png", 
    width = 3000, height = 1500, res = 600)
annotate_figure(Temp, top = text_grob("Effect of relative lifelong temperature on pike growth", color = "black", face = "bold", size = 10, vjust = 1, hjust = 0.7))
dev.off()
```

```{r cluster effect figure, eval=FALSE}
pikes2 <- read.delim("Data/Pike/Pikedata_model.txt", header = T, 
                     stringsAsFactors = F, sep = "\t", dec = ".")

#rename clusters
pikesF <- pikes2%>%
  filter(clust=="F_HighS"|clust=="F_IntS"|clust=="F_LowS")

pikesB <- pikes2%>%
  filter(clust=="S_LowS"|clust=="S_IntS"|clust=="S_HighS")

pikesF$clust <- factor(pikesF$clust,
                       levels = c("F_HighS","F_IntS","F_LowS"),
                       labels = c("FW high S, thermal shift",
                                  "FW resident, thermal shift",
                                  "FW resident, thermal cold"))

pikesB$clust <- factor(pikesB$clust,
                       levels = c("S_LowS","S_IntS","S_HighS"),
                       labels = c("High S, thermal constant",
                                  "Int. S, thermal cold",
                                  "Low S, thermal shift"))

clustB <- ggplot(pikesB[pikesB$lifeyear<=7,], aes(factor(lifeyear), log(inc), color=clust))+
  geom_boxplot(lwd=.3, outlier.shape = NA)+
  labs(x="Age (years)", y=expression(bold("log increment"~(mu*"m"))),
       color="ecotype")+
  scale_x_discrete(breaks=c("1","2","3","4","5","6","7"))+
  scale_color_viridis_d(direction = 1, begin = 0, end = 0.5)+
  theme_classic()+
  theme(panel.grid.major = element_line(),
        legend.position = c(.715,.79),
        legend.background = element_blank(),
        legend.box.background = element_rect(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 10, face = "bold"),
        legend.key.size = unit(.8,"line"))

clustF <- ggplot(pikesF[pikesF$lifeyear<=7,], aes(factor(lifeyear), log(inc), color=clust))+
  geom_boxplot(lwd=.3, outlier.shape = NA)+
  labs(x="Age (years)", y=expression(bold("increment"~(mu*"m"))), color="ecotype")+
  scale_x_discrete(breaks=c("1","2","3","4","5","6","7"))+
  scale_color_viridis_d(direction = 1, begin = 0.5, end = 1)+
  theme_classic()+
  theme(panel.grid.major = element_line(),
        legend.position = c(.715,.79),
        legend.background = element_blank(),
        legend.box.background = element_rect(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 10, face = "bold"),
        legend.key.size = unit(.8,"line"))

Fig <- ggarrange(clustB, clustF, align = "h", labels = c("A", "B"), 
                 label.x = .02, label.y = 1.05)+
  theme(plot.margin = margin(.5,0,0,0,"cm"))

png(filename = "Figures/Cluster_effects_growth.png", 
    width = 4500, height = 2000, res = 600)
annotate_figure(Fig, top = text_grob("Effects of ecotype on pike growth", color = "black", face = "bold", size = 15, vjust = 1, hjust = 1.1))
dev.off()
```

## VB growth models ecotypes
```{r data prep, include=FALSE}
rm(list = ls())

# load data
pikedata <- read.delim("Data/Pike/Pike_TL_backcalulated.txt", header = T, stringsAsFactors = F)

priors <- read.delim("Data/Pike/Priors_pike.csv", sep = ";", 
                     header = T, stringsAsFactors = F)

load("Data/Pike/Adults_element_transects_all.RData")

Bgroup.clus <- Bgroup%>%inner_join(fishassign_B2, by="ID")
Fgroup.clus <- Fgroup%>%inner_join(fishassign_F2, by="ID")

Groupall <- rbind(Bgroup.clus, Fgroup.clus)

Groups <- Groupall%>%
  ungroup()%>%
  transmute(id = ID,
            ecotype=case_when(clust2=="High saline|warm"~1,
                              clust2=="Int saline|cold"~2,
                              clust2=="Low saline|cold"~3,
                              clust2=="FW high saline|shift"~4,
                              clust2=="FW low saline|shift"~5,
                              clust2=="FW low saline|cold"~6
                              ))%>%
  distinct() %>% 
  group_by(ecotype) %>% #Group by ecotype to number each group
  transmute(id = id,
            id2 = row_number(),
            ecotype = ecotype)%>%
  ungroup()%>%
  mutate(id3 = row_number())


#Filter out lake fish and vaterite fish
pikedata2 <- pikedata %>% filter(area != "KD") %>% filter(id != "BH-01908")%>%
  inner_join(Groups, by="id")

# Cleanup
growthdata <- pikedata2 %>%
  transmute(id = id,
            id2 = id2,
            id3 = id3,
            sex = sex,
            weight = weight,
            TL = TL,
            radmm = rad/1000,
            date = date,
            area = area,
            age = age,
            agei = agei,
            ecotype=ecotype)



#Binary variable for sex
#growthdata$sex <- ifelse(growthdata$sex == "f", 0, 1)

# #ID2 variable
# IDfemale <- growthdata %>% filter(sex==0)%>%
#   transmute(id=id)%>%
#   arrange(id)%>%
#   distinct()
# IDfemale$ID2 <- seq(1,nrow(IDfemale),1)
# 
# IDmale <- growthdata %>% filter(sex==1)%>%
#   transmute(id=id)%>%
#   arrange(id)%>%
#   distinct()
# IDmale$ID2 <- seq(1,nrow(IDmale),1)
# 
# IDall <- rbind(IDfemale, IDmale)
# 
# growthdata <- growthdata %>% left_join(IDall, by="id")

standata_growth = list(
  Radmm = growthdata$radmm, 
  Agei = growthdata$agei,
  N = nrow(growthdata),
  n_fish = as.integer(max(growthdata$id3)),
  n_eco = as.integer(max(growthdata$ecotype)),
  fish_id = as.integer(growthdata$id3))
fishtable = unique(growthdata[, c("id3", "ecotype")])
fishtable = fishtable[order(fishtable$id3), ]
standata_growth$eco_id_fish = fishtable$ecotype

standata_growth_2 = list(
  Radmm = growthdata$radmm,
  Agei = growthdata$agei,
  N = nrow(growthdata),
  n_fish = as.integer(max(growthdata$id3)),
  n_eco = as.integer(max(growthdata$ecotype)),
  fish_id = as.integer(growthdata$id3),
  eco_id = as.integer(growthdata$ecotype)
)
```

```{r individual Growth analysis, include=FALSE}
# Script to fit individual-level growth curve
# all groups (now working)
stancode <- ("Data/Stancode/Growth_model_hierarchical_ecotypes_normal_final.stan")
# different grouping, similar to Hhne et al., no transformation
stancode2 <- ("Data/Stancode/Growth_model_hierarchical4_ecotypes_2.stan")
# different grouping with transformation
stancode3 <- ("Data/Stancode/Growth_model_hierarchical4_ecotypes_3.stan")
#normal priors
stancode4 <- ("Data/Stancode/Growth_model_hierarchical4_ecotypes_3_normal.stan")


mod = stan_model(stancode, model_name = "Individual pike growth")

#fitting
fit = sampling(mod, iter = 1000, data = standata_growth, 
           control = list(adapt_delta = 0.95, 
                          max_treedepth = 14))

 #Investigate parameters of interest (Plausible range might be e.g., 
#LInf = 2.5 - 3.5, k = 0.1 - 0.5, tZero = -0.1 - -0.6)
print(fit,pars = c("LInf_eco","k_eco","tZero_eco","phi")) 
print(fit,pars = c("alpha","beta")) 
bayesplot::mcmc_hist(as.array(fit, pars = "phi"))

save(fit, file = "Data/Pike/Fit_individual_ecotypes_GM.RData")
```

```{r playaround priors, include=FALSE, eval=FALSE}
alpha = 0.3^2/0.005
beta =  0.3/0.005
## verify that the mean and variance are 40 and 25, as expected
alpha / beta
## 40
alpha / beta^2
## 25

sim = rgamma(5000, alpha, beta)
quantile(sim, c(0.025, 0.975))

mean = mean(Pikeprior$Loo)
var = sd(Pikeprior$Loo)

sim2 = rnorm(5000, mean, var)
quantile(sim2, c(0.025, 0.975))

#calculate own prior, upper max = 139, cv = cv of growth being between 0.1 and 0.15

fit<-function(mn){
  cv<-5
  quant<-pnorm(139,mn,cv*mn)
  diff<-(0.975-quant)^2
  return(diff)
}

res<-optim(100,fit,method="Brent",lower = 1, upper = 200)

```


```{r individual Growth analysis extract data, include=FALSE}
load("Data/Pike/Fit_individual_ecotypes_GM.RData")

samples <- as.matrix(fit, pars=c("LInf_eco", "k_eco", "tZero_eco"))
head(samples)

sample_LInf <- as.array(fit, pars = c("LInf", "LInf1"))
mcmc_intervals(sample_LInf)
sample_k <- as.array(fit, pars = c("k", "k1"))
mcmc_intervals(sample_k)
sample_tZero <- as.array(fit, pars = c("tZero", "tZero1"))
mcmc_intervals(sample_tZero)
sample_phi <- as.array(fit, pars = "phi")
mcmc_intervals(sample_phi)

summary(fit, pars = "LInf_eco")
```

```{r individual Growth analysis evaluation}
#Evaluation of Stan model for individual fish
#write data matrix for plotting
samples <- as.matrix(fit, pars=c("LInf1","LInf2","k1_mu","k1_sig","k2_mu","k2_sig","tZero1", "tZero2"))
head(samples)

#write arrays for eval
sample_LInf <- as.array(fit, pars = c("LInf1", "LInf2"))
sample_k <- as.array(fit, pars = c("k1", "k2"))
sample_tZero <- as.array(fit, pars = c("tZero1", "tZero2"))
sample_phi <- as.array(fit, pars = "phi")

#Look at parameter space with intervals
mcmc_intervals(sample_LInf)
mcmc_intervals(sample_k)
mcmc_intervals(sample_tZero)
mcmc_intervals(sample_phi)

#Look at summary stats
summary(fit, pars = c("LInf1","LInf2"))
summary(fit, pars = c("k1_mu","k2_mu"))
summary(fit, pars = c("tZero1","tZero2"))
summary(fit, pars = c("phi"))

#MCMC combo plots
mcmc_combo(samples, c("hist", "trace"), pars = c("LInf1", "LInf2"))
mcmc_combo(samples, c("hist", "trace"), pars = c("tZero1", "tZero2"))
mcmc_combo(samples, c("hist", "trace"), pars = c("k1_mu", "k2_mu"))

#Pairs plots
pairs(fit, pars = c("LInf1", "k1_mu", "k1_sig", "tZero1"))
#Not ideal, maybe thin
pairs(fit, pars = c("LInf2", "k2_mu", "k2_sig", "tZero2"))
#same
```

```{r individual Growth analysis plotting}
#prediction function
head(samples)

Incpredict<- function(pars, Agei){
  pars[1]*(1-exp(-pars[2]*(Agei-pars[3])))
}

Pred1 <- t(apply(samples[, c(1, 7, 13)], 1, Incpredict, Agei = 1:15))
Pred2 <- t(apply(samples[, c(2, 8, 14)], 1, Incpredict, Agei = 1:15))
Pred3 <- t(apply(samples[, c(3, 9, 15)], 1, Incpredict, Agei = 1:15))

Pred4 <- t(apply(samples[, c(4, 10, 16)], 1, Incpredict, Agei = 1:15))
Pred5 <- t(apply(samples[, c(5, 11, 17)], 1, Incpredict, Agei = 1:15))
Pred6 <- t(apply(samples[, c(6, 12, 18)], 1, Incpredict, Agei = 1:15))

Predtotal <- rbind(Pred1, Pred2, Pred3, Pred4, Pred5, Pred6)

#Make quantiles
Quantile1 <- data.frame(t(apply(Pred1, 2, quantile, c(0.5, 0.05, 0.95))))
colnames(Quantile1) <- c("median", "lower", "upper")
Quantile1$Agei <- c(1:15)

Quantile2 <- data.frame(t(apply(Pred2, 2, quantile, c(0.5, 0.05, 0.95))))
colnames(Quantile2) <- c("median", "lower", "upper")
Quantile2$Agei <- c(1:15)

Quantile3 <- data.frame(t(apply(Pred3, 2, quantile, c(0.5, 0.05, 0.95))))
colnames(Quantile3) <- c("median", "lower", "upper")
Quantile3$Agei <- c(1:15)

Quantile4 <- data.frame(t(apply(Pred4, 2, quantile, c(0.5, 0.05, 0.95))))
colnames(Quantile4) <- c("median", "lower", "upper")
Quantile4$Agei <- c(1:15)

Quantile5 <- data.frame(t(apply(Pred5, 2, quantile, c(0.5, 0.05, 0.95))))
colnames(Quantile5) <- c("median", "lower", "upper")
Quantile5$Agei <- c(1:15)

Quantile6 <- data.frame(t(apply(Pred6, 2, quantile, c(0.5, 0.05, 0.95))))
colnames(Quantile6) <- c("median", "lower", "upper")
Quantile6$Agei <- c(1:15)

mypallette <- viridis::viridis(6, direction = 1)

Brackish_VB <- ggplot() +
  geom_ribbon(data = Quantile1, aes(x = Agei, ymin = lower, ymax = upper, fill = "FW high S, thermal shift (N=9)"),
              alpha = 0.3)+
  geom_line(data = Quantile1, aes(x = Agei, y = median, color = "FW high S, thermal shift (N=9)"), size=2)+
  geom_ribbon(data = Quantile2, aes(x = Agei, ymin = lower, ymax = upper, fill = "Int. S, thermal cold (N=15)"),
              alpha = 0.3)+
  geom_line(data = Quantile2, aes(x = Agei, y = median, color = "Int. S, thermal cold (N=15)"), size=2)+
  geom_ribbon(data = Quantile3, aes(x = Agei, ymin = lower, ymax = upper, fill = "Low S, thermal shift (N=19)"),
              alpha = 0.3)+
  geom_line(data = Quantile3, aes(x = Agei, y = median, color = "Low S, thermal shift (N=19)"), size=2)+
  scale_color_manual(name = "Assigned cluster",
                     labels = c("FW high S, thermal shift (N=9)","Int. S, thermal cold (N=15)","Low S, thermal shift (N=19)"),
                     values = c(mypallette[1], mypallette[2], mypallette[3]))+
  scale_fill_manual(name = "Assigned cluster",
                    labels = c("FW high S, thermal shift (N=9)","Int. S, thermal cold (N=15)","Low S, thermal shift (N=19)"),
                    values = c(mypallette[1], mypallette[2], mypallette[3]))+
  theme_classic()+
  labs(x="Age", y="otolith increment (mm)")+
    theme(panel.grid.major = element_line(),
        legend.box.background = element_rect(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 5, face = "bold"),
        legend.key.size = unit(.5,"line"),
        legend.position = c(0.3,0.8))

Fresh_VB <- ggplot() +
  geom_ribbon(data = Quantile4, aes(x = Agei, ymin = lower, ymax = upper, fill = "FW high S, thermal shift (N=9)"),
              alpha = 0.3)+
  geom_line(data = Quantile4, aes(x = Agei, y = median, color = "FW high S, thermal shift (N=9)"), size=2)+
  geom_ribbon(data = Quantile5, aes(x = Agei, ymin = lower, ymax = upper, fill = "FW resident, thermal cold (N=4)"),
              alpha = 0.3)+
  geom_line(data = Quantile5, aes(x = Agei, y = median, color = "FW resident, thermal cold (N=4)"), size=2)+
  geom_ribbon(data = Quantile6, aes(x = Agei, ymin = lower, ymax = upper, fill = "FW resident, thermal shift (N=4)"),
              alpha = 0.3)+
  geom_line(data = Quantile6, aes(x = Agei, y = median, color = "FW resident, thermal shift (N=4)"), size=2)+
  scale_color_manual(name = "Assigned cluster",
                     labels = c("FW high S, thermal shift (N=9)","FW resident, thermal cold (N=4)","FW resident, thermal shift (N=4)"),
                     values = c(mypallette[4], mypallette[5], mypallette[6]))+
  scale_fill_manual(name = "Assigned cluster",
                    labels = c("FW high S, thermal shift (N=9)","FW resident, thermal cold (N=4)","FW resident, thermal shift (N=4)"),
                    values = c(mypallette[4], mypallette[5], mypallette[6]))+
  theme_classic()+
  labs(x="Age", y="otolith increment (mm)")+
    theme(panel.grid.major = element_line(),
        legend.box.background = element_rect(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.text.y = element_text(size = 10, face = "bold"),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 5, face = "bold"),
        legend.key.size = unit(.5,"line"),
        legend.position = c(0.3,0.8))

Fig <- ggarrange(Brackish_VB, Fresh_VB, align = "h", labels = c("A", "B"), 
                 label.x = .02, label.y = 1.05)

png(filename = "Figures/VB-curves-ecotypes.png", 
    width = 4500, height = 2000, res = 600)
annotate_figure(Fig, top = text_grob("Lifelong growth of pike ecotypes", 
                                     color = "black", face = "bold", size = 15, vjust = 1.1, hjust = 1))
dev.off()

```


