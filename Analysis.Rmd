---
title: "Project pike"
author: "TR"
date: '2022-09-02'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Setup and cleanup

```{r packages, include=FALSE}
library(tidyverse)
library(ggplot2)
library(lme4)
library(nlme)
library(lmerTest)
library(emmeans)
library(MuMIn)
library(visreg)
library(car)
library(sjPlot)
library(knitr)
library(car)
library(ggpubr)
```

```{r LUNG cleanup for GLMM, include=FALSE, eval=FALSE}
# Script to read in and clean up LUNG data tables
rm(list = ls())

# Read in data
LUNGdata_coast <- read.delim("Data/Environment/Lungdata_all_coast_2005-2020.txt",
                             header = T, stringsAsFactors = F, 
                             sep = "\t", dec = ".")
LUNGdata_rivers <- read.delim("Data/Environment/Lungdata_all_rivers_2005-2020.txt",
                             header = T, stringsAsFactors = F, 
                             sep = "\t", dec = ".")

#Prepare data frames
LUNGdata_coast_clean <- LUNGdata_coast %>%
  transmute(id = MstNr,
            name = Messstelle,
            water_body = Gewässer,
            datetime = DATUM_Uhrzeit,
            parameter = Param_kurz,
            parameter2 = Parameter,
            value = WERT,
            unit = Einheit,
            depth = TIEFE,
            Lat = HW_GEO,
            Long = RW_GEO,
            turbidity = SICHTTIEFE,
            type = "Coast")

LUNGdata_rivers <- LUNGdata_rivers %>%
  transmute(id = MS_NR,
            name = Messstelle,
            water_body = Gewässer,
            datetime = DATUM_Uhrzeit,
            parameter = Param_kurz,
            parameter2 = Parameter,
            value = WERT,
            unit = Einheit,
            depth = NA,
            HW = HW,
            RW = RW,
            turbidity = NA)

# Convert from Gauß-Krueger to WGS84 coordinates--------------------------------
LUNGdata_rivers_GK <- data.frame(cbind(LUNGdata_rivers, "X_GK" = LUNGdata_rivers$RW,
                                       "Y_GK" = LUNGdata_rivers$HW))

coordinates(LUNGdata_rivers_GK) <- c("X_GK", "Y_GK")
proj4string(LUNGdata_rivers_GK) <- CRS("+init=epsg:5650")
LUNGdata_rivers_WGS84 <- spTransform(LUNGdata_rivers_GK, CRS("+init=epsg:4326"))

LUNGdata_rivers_WGS84 <- as.data.frame(LUNGdata_rivers_WGS84)

LUNGdata_rivers_clean <- LUNGdata_rivers_WGS84%>%
  transmute(id = id,
            name = name,
            water_body = water_body,
            datetime = datetime,
            parameter = parameter,
            parameter2 = parameter2,
            value = value,
            unit = unit,
            depth = depth,
            Lat = Y_GK,
            Long = X_GK,
            turbidity = turbidity, 
            type = "Freshwater")

# Filter for variables of interest before converting to wide and join-----------
LUNG_sal_temp_coast <- LUNGdata_coast_clean %>%
  filter(parameter == "W-T"|parameter2=="Wassertemperatur"|
           parameter == "SAL"|parameter2 == "Salzgehalt"|
           parameter == "P"|parameter2 == "Phophor, gesamt")%>%
  transmute(id = id,
            name = name,
            waterbody = water_body,
            date = lubridate::as_date(parse_date_time(datetime, orders = "ymd_HMS")),
            day = lubridate::day(parse_date_time(datetime, orders = "ymd_HMS")),
            month = lubridate::month(parse_date_time(datetime, orders = "ymd_HMS")),
            year = lubridate::year(parse_date_time(datetime, orders = "ymd_HMS")),
            parameter = parameter,
            value = value,
            depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = "LUNG",
            type = type)

LUNG_sal_temp_rivers <- LUNGdata_rivers_clean %>%
  filter(parameter == "W-T"|parameter2=="Wassertemperatur"|
           parameter == "SAL"|parameter2 == "Salzgehalt"|
           parameter == "P"|parameter2 == "Phophor, gesamt")%>%
  transmute(id = id,
            name = name,
            waterbody = water_body,
            date = lubridate::as_date(parse_date_time(datetime, orders = "ymd_HMS")),
            day = lubridate::day(parse_date_time(datetime, orders = "ymd_HMS")),
            month = lubridate::month(parse_date_time(datetime, orders = "ymd_HMS")),
            year = lubridate::year(parse_date_time(datetime, orders = "ymd_HMS")),
            parameter = parameter,
            value = value,
            depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = "LUNG",
            type = type)

#insert NAs for later means
LUNG_sal_temp_rivers <- LUNG_sal_temp_rivers%>%
  group_by(name, year, month, parameter)%>%
  summarize(id = id,
            name = name,
            waterbody = waterbody,
            month = month,
            year = year,
            parameter = parameter,
            value = mean(value, na.rm = T),
            Lat = Lat,
            Long = Long,
            turbidity=turbidity,
            measurement = measurement,
            type = type)%>%
  ungroup()%>%
  distinct()%>%
  pivot_wider(names_from = month, values_from = value)

LUNG_sal_temp_rivers <- LUNG_sal_temp_rivers%>%
  pivot_longer(cols = c(11:22), names_to = "month",
               values_to = "value", values_drop_na = F)

# remove double rows before converting to wide
LUNG_sal_temp_coast <- LUNG_sal_temp_coast[-c(11296, 11298, 563, 564),]

LUNG_sal_temp_coast <- LUNG_sal_temp_coast%>%
  group_by(name, year, month, parameter)%>%
  summarize(id = id,
            name = name,
            waterbody = waterbody,
            month = month,
            year = year,
            parameter = parameter,
            value = mean(value, na.rm = T),
            Lat = Lat,
            Long = Long,
            turbidity=turbidity,
            measurement = measurement,
            type = type)%>%
  ungroup()%>%
  distinct()%>%
  pivot_wider(names_from = month, values_from = value)

LUNG_sal_temp_coast <- LUNG_sal_temp_coast%>%
  pivot_longer(cols = c(11:22), names_to = "month",
               values_to = "value", values_drop_na = F)

# convert to wide
LUNG_sal_temp_coast <- spread(LUNG_sal_temp_coast, parameter, value)
head(LUNG_sal_temp_coast)
LUNG_sal_temp_rivers <- spread(LUNG_sal_temp_rivers, parameter, value)
head(LUNG_sal_temp_rivers)
LUNG_sal_temp_rivers$SAL <- 0

LUNGdata_all <- rbind(LUNG_sal_temp_coast, LUNG_sal_temp_rivers)
names(LUNGdata_all)[13] <- paste("WT")

# Add ID numbers
LUNGdata_all <- LUNGdata_all %>%
  transmute(id = case_when(name %in% "AW1 Trockenort" ~"0111030108",
                           waterbody %in% "Graben 44" ~"0103070022",
                           name %in% "DB6 Barth oe." ~"0103050603",
                           name %in% "DB2 Sundische Wiese" ~"0103050208",
                           name %in% "DB1 Pramort" ~"0103050101",
                           name %in% "GS Gellenstrom Hiddensee w." ~"0103070503",   
                           name %in% "RB2 Vitte oe." ~"0112190202",
                           name %in% "RB3 Bugspitze s." ~"0112190309",
                           name %in% "RB1 Schaprode w." ~"0112400185",
                           name %in% "KB90 Fahrwasser I.Libitz w." ~"0103059085",
                           name %in% "S66 Stralsund" ~"0109016609",
                           name %in% "RB6 Wittower Faehre oe." ~"0112280603",
                           name %in% "RB9 Glowe sw." ~"0112390909",
                           name %in% "RB10 Lietzow n." ~"0112391004",
                           name %in% "RB15 Buschvitz oe." ~"0112391500",
                           name %in% "GB3 Daenische Wiek n." ~"0105010306",
                           name %in% "GB2 I.Vilm s." ~"0105010285",
                           name %in% "GB19 Zentralbereich" ~"0105011907",
                           name %in% "GB7 Struck" ~"0105010701",
                           name %in% "GB10 Ruden s." ~"0111021001",
                           name %in% "O133 suedl. Greifsw. Oie" ~"0111071308",
                           name %in% "P20 Peenemuende s." ~"0111032085",
                           name %in% "P42 Wolgast s." ~"0111034208",
                           name %in% "P48 Lassan" ~"0111034806",
                           TRUE ~ id),
            name = name,
            waterbody = waterbody,
            #date = date,
            #day = day,
            month = month,
            year = year,
            #depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = measurement,
            type = type,
            SAL = SAL,
            WT = WT,
            P=P)

#Must be zero:
unique(ifelse(is.na(LUNGdata_all$id)==T, 1, 0))

# join in 2021 data-------------------------------------------------------------

LUNGdata_coast_21 <- read.delim("Data/Environment/LUNG-Daten_all_coast_2021.txt",
                                header = T, stringsAsFactors = F, 
                                sep = "\t", dec = ".")
#clean
LUNGdata_coast_21 <- LUNGdata_coast_21 %>%
  transmute(id = paste0(0, PN.Stellennr.),
            date = lubridate::as_date(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            day = lubridate::day(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            month = lubridate::month(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            year = lubridate::year(parse_date_time(Probenahmedatum, orders = "dmy_HM")),
            depth = case_when(Tiefeninformation %in% "Grundnähe" ~ "bottom",
                              TRUE ~ "surface"),
            parameter = Parameter,
            value = Endergebnis)%>%
  filter(parameter == "Wassertemperatur"|
           parameter == "Salzgehalt"|
           parameter == "Gesamt P"|
           parameter == "Sichttiefe")

#insert NAs
LUNGdata_coast_21 <- LUNGdata_coast_21%>%
  group_by(id, year, month, parameter)%>%
  summarize(id = id,
            month = month,
            year = year,
            parameter = parameter,
            value = mean(as.numeric(value), na.rm = T))%>%
  ungroup()%>%
  distinct()%>%
  pivot_wider(names_from = month, values_from = value)

LUNGdata_coast_21 <- LUNGdata_coast_21%>%
  pivot_longer(cols = c(4:15), names_to = "month",
               values_to = "value", values_drop_na = F)

LUNGdata_coast_21 <- rbind(LUNGdata_coast_21[LUNGdata_coast_21$year!=2022,],
                           na.omit(LUNGdata_coast_21[LUNGdata_coast_21$year==2022,]))


#wide
LUNGdata_coast_21 <- spread(LUNGdata_coast_21, parameter, value)
head(LUNGdata_coast_21)

LUNGdata_coast_21 <- LUNGdata_coast_21 %>%
  transmute(id = id,
            #date = date,
            #day = day,
            month = month,
            year = year,
            #depth = depth,
            SAL = Salzgehalt,
            WT = Wassertemperatur,
            P_total=`Gesamt P`,
            trbidity=Sichttiefe)

# for loop to complement rows
IDstation <- unique(LUNGdata_coast_21$id)
df <- data.frame()
for (i in 1:length(IDstation)) {
  nm <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]), 
                                 "name"]), NA)))
  wb <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]),
                                 "waterbody"]), NA)))
  Lat <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]), "Lat"]), NA)))
  Long <- na.omit(unlist(ifelse(LUNGdata_coast_21$id == IDstation[i], 
              first(LUNGdata_all[which(LUNGdata_all$id == IDstation[i]), 
                                 "Long"]), NA)))
  df <- rbind(df, data.frame(nm, wb, Lat, Long))
}

#add missing columns
LUNGdata_coast_21 <- cbind(LUNGdata_coast_21, df)
#LUNGdata_coast_21$turbidity <- NA
LUNGdata_coast_21$type <- "Coast"
LUNGdata_coast_21$measurement <- "LUNG"

LUNGdata_coast_21 <- LUNGdata_coast_21 %>%
  transmute(id = id,
            name = nm,
            waterbody = wb,
            #date = date,
            #day = day,
            month = month,
            year = year,
            #depth = depth,
            Lat = Lat,
            Long = Long,
            turbidity = trbidity,
            measurement = measurement,
            type = type,
            SAL = SAL,
            WT = WT,
            P=P_total)

LUNGdata_all <- data.frame(rbind(LUNGdata_all, LUNGdata_coast_21))

LUNGdata_all <- LUNGdata_all%>%
  transmute(waterbody = case_when(name %in% "AW1 Trockenort" ~"P",
                                  name %in% "DB1 Pramort" ~"BAT",
                                  name %in% "DB10 Bodstedt n." ~"BoB",
                                  name %in% "DB16 Saal nw." ~"SaB",
                                  name %in% "DB2 Sundische Wiese" ~"BAT",
                                  name %in% "DB6 Barth oe." ~"BAT",
                                  name %in% "GB10 Ruden s." ~"GB",
                                  name %in% "GB19 Zentralbereich" ~"GB",
                                  name %in% "GB2 I.Vilm s." ~"GB",
                                  name %in% "GB3 Daenische Wiek n." ~"GB",
                                  name %in% "GB7 Struck" ~"GB",
                                  name %in% "GS Gellenstrom Hiddensee w." 
                                  ~"Baltic",
                                  name %in% "KB90 Fahrwasser I.Libitz w." ~"WRB",
                                  name %in% "O133 suedl. Greifsw. Oie" ~"Baltic",
                                  name %in% "P20 Peenemuende s." ~"P",
                                  name %in% "P42 Wolgast s." ~"P",
                                  name %in% "P48 Lassan" ~"P",
                                  name %in% "RB1 Schaprode w." ~"WRB",
                                  name %in% "RB10 Lietzow n." ~"NRB",
                                  name %in% "RB15 Buschvitz oe." ~"KJB",
                                  name %in% "RB2 Vitte oe." ~"WRB",
                                  name %in% "RB3 Bugspitze s." ~"NRB",
                                  name %in% "RB6 Wittower Faehre oe." ~"NRB",
                                  name %in% "RB9 Glowe sw."~"NRB",
                                  name %in% "S66 Stralsund" ~"WRB",
                                  name %in% "Barth" ~"Barthe",
                                  name %in% "Klein Damitz" ~"Bandycksgraben",
                                  name %in% "Wolgast" ~"Ziese",
                                  name %in% "Neuendorf" ~"Sehrowbach",
                                  name %in% "Kemnitz" ~"Ziese",
                                  TRUE~name),
            id = id,
            name = name,
            month = month,
            year = year,
            Lat = Lat,
            Long = Long,
            turbidity = turbidity,
            measurement = measurement,
            type = type,
            SAL = SAL,
            WT = WT,
            P=P)

Lungdata <- LUNGdata_all%>%
  group_by(waterbody, year)%>%
  summarise(type=type,
            turbidity=mean(turbidity, na.rm=T),
            SAL=mean(SAL, na.rm=T),
            WT=mean(WT, na.rm=T),
            P=mean(P, na.rm=T))%>%
  distinct()

# save file
write.table(Lungdata, 
            file = "Data/LUNGdata.txt", 
            sep = "\t", dec = ".", row.names = F)


```

```{r shape data, include=FALSE, eval=FALSE}
#Script to read cleaned environmental data and combine it with pike data
rm(list = ls())

Lungdata <- read.delim("Data/Environment/LUNGdata.txt", header = T, 
                       stringsAsFactors = F, sep = "\t", dec = ".")

pikedat_B <- read.delim("Data/Pike/Growthdata_Bodden-cluster.txt", 
                        sep = "\t", dec = ".", header = T, stringsAsFactors = F)

pikedat_F <- read.delim("Data/Pike/Growthdata_Freshwater-cluster.txt", 
                        sep = "\t", dec = ".", header = T, stringsAsFactors = F)

#Clean up data frames
pikedata_B <- pikedat_B%>%
  transmute(ID=as.character(ID),
            area=area,
            capt=capt,
            clust=as.factor(paste0("S_",clust)),
            age=as.integer(age),
            cohort=as.integer(cohort),
            weight=weigth,
            TL=as.numeric(TL),
            sex=as.factor(sex),
            lifeyear=factor(i, levels = c(1:13), labels = c(1:13)),
            year=year,
            inc=as.numeric(increment),
            rad=as.numeric(rad))

pikedata_F <- pikedat_F%>%
  transmute(ID=as.character(ID),
            area=area,
            capt=capt,
            clust=as.factor(paste0("F_",clust)),
            age=as.integer(age),
            cohort=as.integer(cohort),
            weight=weigth,
            TL=as.numeric(TL),
            sex=as.factor(sex),
            lifeyear=factor(i, levels = c(1:13), labels = c(1:13)),
            year=year,
            inc=as.numeric(increment),
            rad=as.numeric(rad))
#Bind together
pikedata <- rbind(pikedata_B, pikedata_F)

oto_lowres <- read.delim("Data/Pike/Oto_LA-to-d18O_interpolation.txt",
                         header = T, dec = ".", sep = "\t",
                         stringsAsFactors = F)

oto_years <- oto_lowres%>%
  group_by(ID,year)%>%
  summarise(ID=ID,
            lifeyear=as.factor(year),
            d18O_mean=mean(d18O),
            res_mean=mean(res),
            Sr_mean=mean(Sr),
            d18O_min=min(d18O),
            res_min=min(res),
            Sr_min=min(Sr),
            d18O_max=max(d18O),
            res_max=max(res),
            Sr_max=max(Sr))

pikedata <- pikedata%>%inner_join(oto_years, by=c("ID", "lifeyear"))%>%
  transmute(ID=ID,
            waterbody=area,
            capt=capt,
            clust=clust,
            age=age,
            cohort=cohort,
            weight=weight,
            TL=TL,
            sex=sex,
            lifeyear=lifeyear,
            year=year.x,
            inc=inc,
            rad=rad,
            d18O_mean=d18O_mean,
            d18O_max=d18O_max,
            d18O_min=d18O_min,
            res_mean=res_mean,
            res_max=res_max,
            res_min=res_min,
            Sr_mean=Sr_mean,
            Sr_max=Sr_max,
            Sr_min=Sr_min)%>%
  drop_na(inc,rad,year)%>%
  distinct()

pikedata <- pikedata%>%left_join(Lungdata, by=c("waterbody", "year"))

write.table(pikedata, 
            file = "Data/Pikedata.txt", 
            sep = "\t", dec = ".", row.names = F)
```

## Prepare data for modelling

```{r project start, include=FALSE, message=FALSE, warning=FALSE, echo=FALSE}
rm(list = ls())

pikes <- read.delim("Data/Pike/Pikedata.txt", header = T, stringsAsFactors = F,
                    sep = "\t", dec = ".")
head(pikes)
tail(pikes)
str(pikes)

#Prepare data frame with factors and scale+center element data
pikes2 <- pikes%>%
  transmute(ID=ID,
            waterbody=factor(waterbody),
            clust=as.factor(clust),
            sex=as.factor(sex),
            lifeyear=lifeyear,
            inc=inc,
            res_mean=as.numeric(scale(res_mean)),
            Sr_mean=as.numeric(scale(Sr_mean)),
            visibility=as.numeric(scale(turbidity)),
            Sal=as.numeric(scale(SAL)),
            WT=as.numeric(scale(WT)),
            P=as.numeric(scale(P)))
#Check
str(pikes2)
```

## Data exploration

```{r Exploration, include=FALSE, echo=FALSE, fig.height=6, fig.width=8}
#Exploration

par(mfrow=c(1,2))
dotchart(pikes2$inc, color = pikes2$clust, main = "Color = Ecotype(Cluster)")
dotchart(pikes2$inc, color = pikes2$sex, main = "Color = Sex")
```

```{r Exploration, include=FALSE, echo=FALSE, fig.height=5, fig.width=8}
par(mfrow=c(3,2))
boxplot(pikes2$inc~pikes2$lifeyear, ylab ="Growth increment", xlab = "Age")
boxplot(pikes2$inc~pikes2$clust, ylab ="Growth increment", xlab = "Ecotype")
boxplot(pikes2$inc~pikes2$sex, ylab ="Growth increment", xlab = "Sex")
plot(pikes2$inc~pikes2$res_mean, ylab ="Growth increment", xlab = "d18O")
plot(pikes2$inc~pikes2$Sr_mean, ylab ="Growth increment", xlab = "Sr")
plot(0, xaxt = 'n', yaxt = 'n', bty = 'n', pch = '', ylab = '', xlab = '')
```

```{r Exploration, include=FALSE, echo=FALSE, fig.height=5, fig.width=8}
par(mfrow = c(2,2))
hist(pikes2$inc, main = "", xlab = "Increment (um)")
hist(pikes2$res_mean, main = "", xlab = "d18O ratio")
hist(pikes2$Sr_mean, main = "", xlab = "Sr concentration")
plot(0, xaxt = 'n', yaxt = 'n', bty = 'n', pch = '', ylab = '', xlab = '')

```

## Initial model
$log10(Inc) \sim Age+Age*cluster+Age*d18Ores+Srmean+turbidity+salinity+WT+P+Sex+(1|Loc/ID)$

```{r exclude random effect of ID}
#Run model
pikemodel.1 <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                        Sr_mean+sex+(1|waterbody/ID), 
                      REML = T, data = pikes2)
summary(pikemodel.1)
#Random effects cannot e estimated as too low variance
#Model runs properly when excluding ID:
pikemodel.1.0 <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = T, data = pikes2)
summary(pikemodel.1.0)
```
 
## New model
$log10(Inc) \sim Age+Age*cluster+Age*d18Ores+Srmean+turbidity+salinity+WT+P+Sex+(1|Loc)$

```{r Look at variance inflation factors, echo=TRUE}
#Look at variance inflation factors


pike.vif <- vif(pikemodel.1.0)

barplot(pike.vif[,3], main = "VIF values", horiz = F, col = "darkgreen", ylim = c(0,6),
        las = 2)
abline(h = 5, lwd = 3, lty = 2, col="red")
```

## Random effects not significant
```{r test random effects, echo=TRUE}
#Test model components
#Test random effects
rand(pikemodel.1.0)
```

\newpage
## Age is significant
```{r test effects age, echo=TRUE}
#Remove age quadratic term
pikemodel.1.0 <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = F, data = pikes2)

pikemodel.noage <- update(pikemodel.1.0, ~. -I(lifeyear^2))

anova(pikemodel.1.0, pikemodel.noage)
#age is significant
```
## Age*cluster is significant
```{r test cluster effects}
pikemodel.noclust <- update(pikemodel.1.0, ~. -lifeyear*clust)

anova(pikemodel.1.0, pikemodel.noclust)
```
## Relative d18O is significant
```{r test effects d18O, echo=TRUE}
#Remove d18O
pikemodel.nores <- update(pikemodel.1.0, ~. -lifeyear*res_mean)
anova(pikemodel.1.0, pikemodel.nores)
#relative d18O significant
```
## Relative Sr is not significant
```{r test effects Sr, echo=TRUE}
#Remove Sr
pikemodel.noSr <- update(pikemodel.1.0, ~. -Sr_mean)
anova(pikemodel.1.0, pikemodel.noSr)
#Sr not significant
```
## Sex is significant
```{r test effects sex, echo=TRUE}
#Remove sex
pikemodel.nosex <- update(pikemodel.1.0, ~. -sex)
anova(pikemodel.1.0, pikemodel.nosex)
#sex is significant
```

## Results
```{r table, out.width="120%", dpi=300, echo=FALSE, message=FALSE}
tab_model(pikemodel.final)
```

## Model validation
```{r model validation, echo=FALSE}
#validation
pikemodel.final <- lmer(log10(inc)~lifeyear*res_mean+lifeyear*clust+I(lifeyear^2)+
                      Sr_mean+sex+(1|waterbody), 
                      REML = T, data = pikes2)

pikes2$resid <- resid(pikemodel.final)

plot(pikemodel.final, xlab = "Fitted", ylab = "Residuals")
hist(pikes2$resid, main = "", xlab = "Residuals")

qqnorm(resid(pikemodel.final))
qqline(resid(pikemodel.final))


plot(pikes2$resid~pikes2$clust, ylab = "Residuals", xlab = "Cluster", las = 2)
plot(pikes2$resid~pikes2$sex, ylab = "Residuals", xlab = "Sex")
plot(pikes2$resid~pikes2$lifeyear, ylab = "Residuals", xlab = "Age")
plot(pikes2$resid~pikes2$res_mean, ylab = "Residuals", xlab = "d18O")
plot(pikes2$resid~pikes2$Sr_mean, ylab = "Residuals", xlab = "Sr concentration")

r.squaredGLMM(pikemodel.final)
```


```{r temp & clust effect figure}
#factorize temperature
pikes2$agefact <- ifelse(pikes2$lifeyear<3, 2, 
                         ifelse(pikes2$lifeyear>2&pikes2$lifeyear<7, 1,
                                ifelse(pikes2$lifeyear>6, 3, NA)))

pikes2$agefact2 <- factor(pikes2$agefact,levels = c(2,1,3),
                                            labels = c("juvenile", "adult", "trophy"))

#rename clusters
pikes3 <- pikes2%>%
  mutate(clust2=case_when(clust=="F_HighS"~3,
                          clust=="F_IntS"~3,
                          clust=="F_LowS"~1,
                          clust=="S_HighS"~2,
                          clust=="S_IntS"~4,
                          clust=="S_LowS"~4))
pikes3$clust <- factor(pikes3$clust2,
                       levels = c(1,2,3,4),
                       labels = c("Freshwater resident/stable temperature", 
                                  "Brackish resident/stable temperature",
                                  "Anadromous/thermal shift",
                                  "Semianadromous/thermal shift"))

mypallette <- viridis::viridis(4, direction = 1)

#Temperature effect
Temp <- ggplot(pikes2, aes(res_mean, inc, color=agefact2))+
  geom_point(size=.5)+
  stat_smooth(method = "lm", fill="gray", fullrange = T, lwd=.8)+
  labs(x=expression(bold("scaled"~delta^18*"O"~("Sr-corrected, VPDB \u2030"))), 
       y=expression(bold("increment"~(mu*"m"))),
       color="ageclass")+
  scale_color_viridis_d()+
  theme_classic()+
  theme(panel.grid.major = element_line(),
        legend.position = c(.803,.825),
        legend.background = element_blank(),
        legend.box.background = element_rect(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_text(size = 10, face = "bold"),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 10, face = "bold"),
        legend.key.size = unit(.8,"line"))

#Cluster effect
Clust <- ggplot(pikes3[pikes$lifeyear<=10,], aes(factor(lifeyear), inc, color=clust))+
  geom_boxplot(lwd=.3, outlier.size = .5)+
  labs(x="Age (years)", y=expression(bold("increment"~(mu*"m"))), color="ecotype")+
  scale_x_discrete(breaks=c("1","2","3","4","5","6","7","8","9","10"))+
  scale_color_manual(breaks = c("Freshwater resident/stable temperature", 
                                  "Brackish resident/stable temperature",
                                  "Anadromous/thermal shift",
                                  "Semianadromous/thermal shift"),
                     values = mypallette)+
  theme_classic()+
  theme(panel.grid.major = element_line(),
        legend.position = c(.715,.79),
        legend.background = element_blank(),
        legend.box.background = element_rect(),
        axis.line = element_line(size = .5, colour = "black", linetype = 1),
        axis.ticks = element_line(size = .5, colour = "black"),
        axis.text = element_text(size = 10, colour = "black"),
        axis.text.y = element_blank(),
        axis.title.x = element_text(size = 10, face = "bold"),
        axis.title.y = element_blank(),
        legend.text = element_text(size = 5),
        legend.title = element_text(size = 10, face = "bold"),
        legend.key.size = unit(.8,"line"))

png(filename = "Figures/Interaction_effects_growth.png", 
    width = 4500, height = 1800, res = 600)
ggarrange(Temp, Clust, align = "h")
dev.off()
```
